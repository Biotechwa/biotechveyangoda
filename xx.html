<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Biotech | AI Report Assistant</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tesseract OCR -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Noto+Sans+Sinhala:wght@400;700&family=Noto+Sans+Tamil:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #f1f5f9;
            height: 100dvh; 
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
            overflow: hidden;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        }

        /* Animations */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        
        @keyframes pulse-ring {
            0% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 15px rgba(255, 255, 255, 0); }
            100% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
        }

        @keyframes blob {
            0% { transform: translate(0px, 0px) scale(1); }
            33% { transform: translate(30px, -50px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
            100% { transform: translate(0px, 0px) scale(1); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        @keyframes scanline {
            0% { top: 0%; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        .animate-float { animation: float 3s ease-in-out infinite; }
        .animate-pulse-slow { animation: pulse-ring 2s infinite; }
        .animate-blob { animation: blob 7s infinite alternate; }
        .animation-delay-2000 { animation-delay: 2s; }
        .animate-shake { animation: shake 0.2s ease-in-out 0s 2; }

        .scanner-line {
            position: absolute;
            left: 0;
            width: 100%;
            height: 3px;
            background: #10b981;
            box-shadow: 0 0 15px 4px rgba(16, 185, 129, 0.6);
            animation: scanline 2s cubic-bezier(0.4, 0, 0.2, 1) infinite;
            z-index: 10;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .chat-container {
            width: 100%;
            height: 100%;
            max-width: 480px;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 10;
        }

        @media (min-width: 640px) {
            .chat-container {
                height: 90vh;
                border-radius: 32px;
                overflow: hidden;
                box-shadow: 0 25px 50px -12px rgba(15, 118, 110, 0.25);
            }
        }

        .chat-body {
            flex-grow: 1;
            overflow-y: auto;
            padding: 24px;
            padding-bottom: 32px; /* Fixes mobile issue where bottom buttons hide behind footer */
            background-color: transparent;
            display: flex;
            flex-direction: column;
            gap: 18px;
            scroll-behavior: smooth;
        }

        /* Message Bubbles */
        .msg {
            max-width: 85%;
            padding: 14px 18px;
            border-radius: 20px;
            font-size: 14.5px;
            line-height: 1.6;
            animation: slideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            word-break: break-word;
        }

        .msg-bot {
            background: white;
            color: #1e293b;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            box-shadow: 0 4px 15px -3px rgba(0,0,0,0.05);
        }

        .msg-user {
            background: linear-gradient(135deg, #0d9488 0%, #0f766e 100%);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
            box-shadow: 0 10px 15px -3px rgba(13, 148, 136, 0.3);
        }

        /* Option Buttons */
        .option-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 15px;
        }

        .option-btn {
            background: #f8fafc;
            border: 1.5px solid #e2e8f0;
            padding: 14px;
            border-radius: 16px;
            text-align: center;
            font-weight: 700;
            color: #0f766e;
            transition: all 0.3s;
            cursor: pointer;
            display: block;
            user-select: none;
        }

        .option-btn:hover {
            border-color: #0d9488;
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(13, 148, 136, 0.1);
        }

        .typing-dots { display: flex; gap: 4px; padding: 4px 0; justify-content: center;}
        .dot { width: 6px; height: 6px; background: #94a3b8; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }

        .custom-input {
            background: #f1f5f9;
            border: 2px solid transparent;
            border-radius: 16px;
            padding: 12px 16px;
            width: 100%;
            outline: none;
            transition: all 0.2s;
            font-weight: 600;
        }
        .custom-input:focus {
            background: white;
            border-color: #0d9488;
            box-shadow: 0 0 0 4px rgba(13, 148, 136, 0.1);
        }
        .input-error {
            border-color: #ef4444 !important;
            background: #fef2f2 !important;
        }
    </style>
</head>
<body class="relative">

    <!-- Animated Background Blobs -->
    <div class="absolute top-0 left-0 w-80 h-80 bg-teal-200 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob"></div>
    <div class="absolute bottom-0 right-0 w-80 h-80 bg-blue-200 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-2000"></div>

    <div class="chat-container glass-effect">
        
        <!-- Premium Header -->
        <div class="bg-gradient-to-r from-teal-600 to-blue-600 p-6 text-center relative overflow-hidden">
            <div class="absolute inset-0 opacity-10" style="background-image: radial-gradient(#fff 1px, transparent 1px); background-size: 15px 15px;"></div>
            
            <div class="relative inline-block mb-3">
                <div class="absolute inset-0 bg-white rounded-full opacity-20 animate-pulse-slow"></div>
                <div class="relative bg-white text-teal-600 w-14 h-14 rounded-full flex items-center justify-center shadow-lg mx-auto animate-float">
                    <i class="fa-solid fa-microscope text-2xl"></i>
                </div>
            </div>
            
            <h1 class="text-white font-extrabold text-xl tracking-wide relative z-10">BIOTECH LABORATORY</h1>
            <p class="text-teal-100 text-[10px] font-medium tracking-widest relative z-10 uppercase">AI Clinical Assistant</p>
            
            <button onclick="resetLanguage()" class="absolute top-4 right-4 text-white/50 hover:text-white transition group" title="Change Language & History">
                <i class="fa-solid fa-globe group-hover:rotate-12 transition-transform"></i>
            </button>
        </div>

        <!-- Chat Area -->
        <div class="chat-body" id="chatBody">
            <!-- Messages injected here -->
        </div>

        <!-- Progress Footer -->
        <div class="p-5 bg-white/50 border-t border-teal-100/50 text-center">
            <div class="flex items-center justify-center gap-2 text-teal-600/60 font-bold text-[10px] tracking-widest uppercase">
                <i class="fa-solid fa-shield-halved"></i>
                End-to-End Encrypted Portal
            </div>
        </div>

        <!-- Language Modal -->
        <div id="langModal" class="modal-overlay absolute inset-0 bg-white/80 backdrop-blur-md z-50 flex items-center justify-center hidden">
            <div class="w-full max-w-[320px] p-8 text-center animate-float">
                <div class="w-20 h-20 bg-teal-600 text-white rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-2xl rotate-3">
                    <i class="fa-solid fa-language text-3xl"></i>
                </div>
                <h3 class="text-2xl font-black text-slate-800 mb-2">Welcome</h3>
                <p class="text-sm text-slate-500 mb-8">Select your preferred language to begin.</p>
                <div class="flex flex-col gap-3">
                    <button onclick="saveAndInit('en')" class="option-btn !bg-white">English</button>
                    <button onclick="saveAndInit('si')" class="option-btn !bg-white" style="font-family: 'Noto Sans Sinhala'">‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω</button>
                    <button onclick="saveAndInit('ta')" class="option-btn !bg-white" style="font-family: 'Noto Sans Tamil'">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const chatBody = document.getElementById('chatBody');
        const scriptURL = 'https://script.google.com/macros/s/AKfycbw24C_gOzLbDjR3Y7wbo8uH087cDIq2xTi13qGvm4e4m2bOEalZUufo7tq8SFQVXLm-/exec';
        
        let currentLang = 'en';
        let formData = { type: '', num: '', date: '', phone: '', patientName: '' };

        // Persistent Memory State
        let chatHistory = JSON.parse(localStorage.getItem('biotech_chat_history')) || [];
        let savedPatientName = localStorage.getItem('biotech_patient_name') || '';

        const i18n = {
            en: {
                welcome: "Hello! üëã I'm your Biotech Assistant. I'll help you access your laboratory reports instantly.",
                welcomeBackGen: "Welcome back! üëã Ready to check another report?",
                welcomeBack: "Welcome back, <b>{name}</b>! üëã Ready to check another report?",
                btnContinue: "Continue Chat",
                btnNewChat: "Start New Chat",
                askMethod: "How would you like to provide your details?",
                btnManual: "Enter Manually",
                btnUpload: "Upload Bill Photo",
                askType: "First, please select your <b>Sample Type</b> code:",
                askNum: "Great. Now, enter your <b>Sample Number</b>:",
                askDate: "When was this sample collected?",
                askPhone: "Finally, enter your registered <b>Phone Number</b>:",
                phoneError: "‚ö†Ô∏è That doesn't look like a valid number. Please ensure it has <b>exactly 10 digits</b> and <b>starts with 0</b> (e.g., 0712345678).",
                greeting: "Hello, <b>{name}</b>! üëã I've found your details.",
                reviewMsg: "Extraction Complete! Are these details correct?",
                btnYes: "Yes, Proceed",
                btnRetake: "No, Retake Photo",
                rejectMsg: "‚ö†Ô∏è Verification Failed. This does not appear to be a valid BIOTEC Laboratory bill. Please upload a clear photo or enter details manually.",
                btnConfirm: "Confirm Details",
                fetching: "Verifying credentials and fetching report...",
                ready: "Secure link generated! Redirecting...",
                btnDone: "Submit"
            },
            si: {
                welcome: "‡∂Ü‡∂∫‡∑î‡∂∂‡∑ù‡∑Ä‡∂±‡∑ä! üëã ‡∂∏‡∂∏ Biotech ‡∑É‡∑Ñ‡∑è‡∂∫‡∂ö‡∂∫‡∑è. ‡∂î‡∂∂‡∂ú‡∑ö ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è ‡∂Ω‡∂∂‡∑è ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∂ß ‡∂∏‡∂∏ ‡∂ã‡∂Ø‡∑Ä‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±‡∂∏‡∑ä.",
                welcomeBackGen: "‡∂±‡∑ê‡∑Ä‡∂≠‡∂≠‡∑ä ‡∑É‡∑è‡∂Ø‡∂ª‡∂∫‡∑ô‡∂±‡∑ä ‡∂¥‡∑í‡∑Ö‡∑í‡∂ú‡∂±‡∑í‡∂∏‡∑î! üëã ‡∂Ö‡∂¥‡∑í ‡∂ä‡∑Ö‡∂ü ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä ‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è ‡∂ö‡∂ª‡∂∏‡∑î‡∂Ø?",
                welcomeBack: "‡∂±‡∑ê‡∑Ä‡∂≠‡∂≠‡∑ä ‡∑É‡∑è‡∂Ø‡∂ª‡∂∫‡∑ô‡∂±‡∑ä ‡∂¥‡∑í‡∑Ö‡∑í‡∂ú‡∂±‡∑í‡∂∏‡∑î <b>{name}</b>! üëã ‡∂Ö‡∂¥‡∑í ‡∂ä‡∑Ö‡∂ü ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä ‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è ‡∂ö‡∂ª‡∂∏‡∑î‡∂Ø?",
                btnContinue: "‡∂ö‡∂≠‡∑è‡∂∂‡∑Ñ ‡∂ö‡∂ª‡∂ú‡∑ô‡∂± ‡∂∫‡∂±‡∑ä‡∂±",
                btnNewChat: "‡∂Ö‡∂Ω‡∑î‡∂≠‡∑ä ‡∂ö‡∂≠‡∑è‡∂∂‡∑Ñ‡∂ö‡∑ä ‡∂¥‡∂ß‡∂±‡∑ä‡∂ú‡∂±‡∑ä‡∂±",
                askMethod: "‡∂î‡∂∂‡∂ú‡∑ö ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª ‡∂Ω‡∂∂‡∑è ‡∂Ø‡∑ô‡∂±‡∑ä‡∂±‡∑ö ‡∂ö‡∑ô‡∑É‡∑ö‡∂Ø?",
                btnManual: "‡∂Ö‡∂≠‡∑í‡∂±‡∑ä ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±",
                btnUpload: "‡∂∂‡∑í‡∂Ω‡∑ä‡∂¥‡∂≠‡∑ö ‡∂°‡∑è‡∂∫‡∑è‡∂ª‡∑ñ‡∂¥‡∂∫‡∂ö‡∑ä ‡∂Ø‡∑ô‡∂±‡∑ä‡∂±",
                askType: "‡∂¥‡∑Ö‡∂∏‡∑î‡∑Ä, ‡∂î‡∂∂‡∑ö <b>‡∑É‡∑è‡∂∏‡∑ä‡∂¥‡∂Ω ‡∑Ä‡∂ª‡∑ä‡∂ú‡∂∫</b> (Sample Type) ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±:",
                askNum: "‡∂Ø‡∑ê‡∂±‡∑ä, ‡∂î‡∂∂‡∑ö <b>‡∑É‡∑è‡∂∏‡∑ä‡∂¥‡∂Ω ‡∂Ö‡∂Ç‡∂ö‡∂∫</b> ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±:",
                askDate: "‡∑É‡∑è‡∂∏‡∑ä‡∂¥‡∂Ω‡∂∫ ‡∂Ω‡∂∂‡∑è‡∂ú‡∂≠‡∑ä <b>‡∂Ø‡∑í‡∂±‡∂∫</b> ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±:",
                askPhone: "‡∂Ö‡∑Ä‡∑É‡∑è‡∂± ‡∑Ä‡∑Å‡∂∫‡∑ô‡∂±‡∑ä, ‡∂î‡∂∂ ‡∂Ω‡∑í‡∂∫‡∑è‡∂¥‡∂Ø‡∑í‡∂Ç‡∂†‡∑í ‡∂ö‡∑Ö <b>‡∂Ø‡∑î‡∂ª‡∂ö‡∂Æ‡∂± ‡∂Ö‡∂Ç‡∂ö‡∂∫</b> ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±:",
                phoneError: "‚ö†Ô∏è ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∑Ö ‡∂Ö‡∂Ç‡∂ö‡∂∫ ‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í‡∂∫‡∑í. ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂ë‡∂∫ <b>‡∂∂‡∑í‡∂±‡∑ä‡∂Ø‡∑î‡∑Ä‡∑ô‡∂±‡∑ä (0) ‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑ ‡∑Ä‡∂±</b> ‡∂â‡∂Ω‡∂ö‡∑ä‡∂ö‡∂∏‡∑ä 10 ‡∂ö ‡∂Ö‡∂Ç‡∂ö‡∂∫‡∂ö‡∑ä ‡∂∂‡∑Ä ‡∂≠‡∑Ñ‡∑Ä‡∑î‡∂ª‡∑î ‡∂ö‡∂ª‡∂ú‡∂±‡∑ä‡∂±.",
                greeting: "‡∂Ü‡∂∫‡∑î‡∂∂‡∑ù‡∑Ä‡∂±‡∑ä <b>{name}</b>! üëã ‡∂∏‡∂∏ ‡∂î‡∂∂‡∑ö ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª ‡∑Ñ‡∂≥‡∑î‡∂±‡∑è ‡∂ú‡∂≠‡∑ä‡∂≠‡∑è.",
                reviewMsg: "‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö‡∂∫‡∑í! ‡∂∏‡∑ô‡∂∏ ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª ‡∂±‡∑í‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í‡∂Ø?",
                btnYes: "‡∂î‡∑Ä‡∑ä, ‡∂â‡∂Ø‡∑í‡∂ª‡∑í‡∂∫‡∂ß ‡∂∫‡∂±‡∑ä‡∂±",
                btnRetake: "‡∂±‡∑ê‡∑Ñ‡∑ê, ‡∂±‡∑ê‡∑Ä‡∂≠ ‡∂°‡∑è‡∂∫‡∑è‡∂ª‡∑ñ‡∂¥‡∂∫‡∂ö‡∑ä ‡∂ú‡∂±‡∑ä‡∂±",
                rejectMsg: "‚ö†Ô∏è ‡∂∏‡∑ô‡∂∫ ‡∑Ä‡∂Ω‡∂Ç‡∂ú‡∑î BIOTEC ‡∂∂‡∑í‡∂Ω‡∑ä‡∂¥‡∂≠‡∂ö‡∑ä ‡∂±‡∑ú‡∑Ä‡∂± ‡∂∂‡∑Ä ‡∂¥‡∑ô‡∂±‡∑ö. ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂¥‡∑ê‡∑Ñ‡∑ê‡∂Ø‡∑í‡∂Ω‡∑í ‡∂°‡∑è‡∂∫‡∑è‡∂ª‡∑ñ‡∂¥‡∂∫‡∂ö‡∑ä ‡∂Ω‡∂∂‡∑è ‡∂Ø‡∑ô‡∂±‡∑ä‡∂± ‡∑Ñ‡∑ù ‡∂Ö‡∂≠‡∑í‡∂±‡∑ä ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.",
                btnConfirm: "‡∂≠‡∑Ñ‡∑Ä‡∑î‡∂ª‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂±",
                fetching: "‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è ‡∂ö‡∂ª‡∂∏‡∑í‡∂±‡∑ä ‡∂¥‡∑Ä‡∂≠‡∑ì...",
                ready: "‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä ‡∑É‡∑ñ‡∂Ø‡∑è‡∂±‡∂∏‡∑ä! ‡∑Ä‡∑í‡∑Ä‡∑ò‡∂≠ ‡∑Ä‡∑ô‡∂∏‡∑í‡∂±‡∑ä ‡∂¥‡∑Ä‡∂≠‡∑ì...",
                btnDone: "‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±"
            },
            ta: {
                welcome: "‡Æµ‡Æ£‡Æï‡Øç‡Æï‡ÆÆ‡Øç! üëã ‡Æ®‡Ææ‡Æ©‡Øç ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç Biotech ‡Æâ‡Æ§‡Æµ‡Æø‡ÆØ‡Ææ‡Æ≥‡Æ∞‡Øç. ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡ÆÖ‡Æ±‡Æø‡Æï‡Øç‡Æï‡Øà‡Æï‡Æ≥‡Øà‡Æ™‡Øç ‡Æ™‡ØÜ‡Æ± ‡Æ®‡Ææ‡Æ©‡Øç ‡Æâ‡Æ§‡Æµ‡ØÅ‡Æï‡Æø‡Æ±‡Øá‡Æ©‡Øç.",
                welcomeBackGen: "‡ÆÆ‡ØÄ‡Æ£‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç ‡Æµ‡Æ∞‡ØÅ‡Æï! üëã ‡ÆÖ‡Æü‡ØÅ‡Æ§‡Øç‡Æ§ ‡ÆÖ‡Æ±‡Æø‡Æï‡Øç‡Æï‡Øà‡ÆØ‡Øà ‡Æö‡Æ∞‡Æø‡Æ™‡Ææ‡Æ∞‡Øç‡Æï‡Øç‡Æï ‡Æ§‡ÆØ‡Ææ‡Æ∞‡Ææ?",
                welcomeBack: "‡ÆÆ‡ØÄ‡Æ£‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç ‡Æµ‡Æ∞‡ØÅ‡Æï <b>{name}</b>! üëã ‡ÆÖ‡Æü‡ØÅ‡Æ§‡Øç‡Æ§ ‡ÆÖ‡Æ±‡Æø‡Æï‡Øç‡Æï‡Øà‡ÆØ‡Øà ‡Æö‡Æ∞‡Æø‡Æ™‡Ææ‡Æ∞‡Øç‡Æï‡Øç‡Æï ‡Æ§‡ÆØ‡Ææ‡Æ∞‡Ææ?",
                btnContinue: "‡ÆÖ‡Æ∞‡Æü‡Øç‡Æü‡Øà‡ÆØ‡Øà ‡Æ§‡Øä‡Æü‡Æ∞‡Æµ‡ØÅ‡ÆÆ‡Øç",
                btnNewChat: "‡Æ™‡ØÅ‡Æ§‡Æø‡ÆØ ‡ÆÖ‡Æ∞‡Æü‡Øç‡Æü‡Øà‡ÆØ‡Øà‡Æ§‡Øç ‡Æ§‡Øä‡Æü‡Æô‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç",
                askMethod: "‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æµ‡Æø‡Æµ‡Æ∞‡Æô‡Øç‡Æï‡Æ≥‡Øà ‡Æé‡Æµ‡Øç‡Æµ‡Ææ‡Æ±‡ØÅ ‡Æµ‡Æ¥‡Æô‡Øç‡Æï ‡Æµ‡Æø‡Æ∞‡ØÅ‡ÆÆ‡Øç‡Æ™‡ØÅ‡Æï‡Æø‡Æ±‡ØÄ‡Æ∞‡Øç‡Æï‡Æ≥‡Øç?",
                btnManual: "‡Æï‡Øà‡ÆÆ‡ØÅ‡Æ±‡Øà‡ÆØ‡Ææ‡Æï ‡Æâ‡Æ≥‡Øç‡Æ≥‡Æø‡Æü‡ØÅ‡Æï",
                btnUpload: "‡Æ™‡Æø‡Æ≤‡Øç ‡Æ™‡ØÅ‡Æï‡Øà‡Æ™‡Øç‡Æ™‡Æü‡ÆÆ‡Øç ‡Æ™‡Æ§‡Æø‡Æµ‡Øá‡Æ±‡Øç‡Æ±‡ØÅ‡Æï",
                askType: "‡ÆÆ‡ØÅ‡Æ§‡Æ≤‡Æø‡Æ≤‡Øç, ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç <b>‡ÆÆ‡Ææ‡Æ§‡Æø‡Æ∞‡Æø ‡Æµ‡Æï‡Øà</b>‡ÆØ‡Øà‡Æ§‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æ®‡Øç‡Æ§‡ØÜ‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç:",
                askNum: "‡Æá‡Æ™‡Øç‡Æ™‡Øã‡Æ§‡ØÅ, ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç <b>‡ÆÆ‡Ææ‡Æ§‡Æø‡Æ∞‡Æø ‡Æé‡Æ£‡Øç</b>‡Æ£‡Øà ‡Æâ‡Æ≥‡Øç‡Æ≥‡Æø‡Æü‡Æµ‡ØÅ‡ÆÆ‡Øç:",
                askDate: "‡ÆÆ‡Ææ‡Æ§‡Æø‡Æ∞‡Æø ‡Æé‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü <b>‡Æ§‡Øá‡Æ§‡Æø</b>‡ÆØ‡Øà‡Æ§‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æ®‡Øç‡Æ§‡ØÜ‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç:",
                askPhone: "‡Æá‡Æ±‡ØÅ‡Æ§‡Æø‡ÆØ‡Ææ‡Æï, ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç <b>‡Æ§‡Øä‡Æ≤‡Øà‡Æ™‡Øá‡Æö‡Æø ‡Æé‡Æ£‡Øç</b>‡Æ£‡Øà ‡Æâ‡Æ≥‡Øç‡Æ≥‡Æø‡Æü‡Æµ‡ØÅ‡ÆÆ‡Øç:",
                phoneError: "‚ö†Ô∏è ‡Æâ‡Æ≥‡Øç‡Æ≥‡Æø‡Æü‡Øç‡Æü ‡Æé‡Æ£‡Øç ‡Æ§‡Æµ‡Æ±‡Ææ‡Æ©‡Æ§‡ØÅ. ‡ÆÖ‡Æ§‡ØÅ <b>0 ‡Æá‡Æ≤‡Øç ‡ÆÜ‡Æ∞‡ÆÆ‡Øç‡Æ™‡Æø‡Æ§‡Øç‡Æ§‡ØÅ</b> ‡Æö‡Æ∞‡Æø‡ÆØ‡Ææ‡Æï 10 ‡Æá‡Æ≤‡Æï‡Øç‡Æï‡Æô‡Øç‡Æï‡Æ≥‡Øà‡Æï‡Øç ‡Æï‡Øä‡Æ£‡Øç‡Æü‡Æø‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡Æ§‡Øà ‡Æâ‡Æ±‡ØÅ‡Æ§‡Æø‡Æ™‡Øç‡Æ™‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡Æµ‡ØÅ‡ÆÆ‡Øç.",
                greeting: "‡Æµ‡Æ£‡Æï‡Øç‡Æï‡ÆÆ‡Øç <b>{name}</b>! üëã ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æµ‡Æø‡Æµ‡Æ∞‡Æô‡Øç‡Æï‡Æ≥‡Øà ‡Æï‡Æ£‡Øç‡Æü‡Æ±‡Æø‡Æ®‡Øç‡Æ§‡ØÅ‡Æ≥‡Øç‡Æ≥‡Øá‡Æ©‡Øç.",
                reviewMsg: "‡Æµ‡ØÜ‡Æ±‡Øç‡Æ±‡Æø! ‡Æá‡Æ®‡Øç‡Æ§ ‡Æµ‡Æø‡Æµ‡Æ∞‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡Æö‡Æ∞‡Æø‡ÆØ‡Ææ‡Æ©‡Æµ‡Øà‡ÆØ‡Ææ?",
                btnYes: "‡ÆÜ‡ÆÆ‡Øç, ‡Æ§‡Øä‡Æü‡Æ∞‡Øç‡Æï",
                btnRetake: "‡Æá‡Æ≤‡Øç‡Æ≤‡Øà, ‡ÆÆ‡ØÄ‡Æ£‡Øç‡Æü‡ØÅ‡ÆÆ‡Øç ‡Æ™‡Æü‡ÆÆ‡Øç ‡Æé‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç",
                rejectMsg: "‚ö†Ô∏è ‡Æá‡Æ§‡ØÅ ‡Æö‡ØÜ‡Æ≤‡Øç‡Æ≤‡ØÅ‡Æ™‡Æü‡Æø‡ÆØ‡Ææ‡Æ© BIOTEC ‡Æ™‡Æø‡Æ≤‡Øç ‡Æá‡Æ≤‡Øç‡Æ≤‡Øà ‡Æé‡Æ©‡Æ§‡Øç ‡Æ§‡Øã‡Æ©‡Øç‡Æ±‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ. ‡Æ§‡ØÜ‡Æ≥‡Æø‡Æµ‡Ææ‡Æ© ‡Æ™‡ØÅ‡Æï‡Øà‡Æ™‡Øç‡Æ™‡Æü‡Æ§‡Øç‡Æ§‡Øà ‡Æ™‡Æ§‡Æø‡Æµ‡Øá‡Æ±‡Øç‡Æ±‡Æµ‡ØÅ‡ÆÆ‡Øç ‡ÆÖ‡Æ≤‡Øç‡Æ≤‡Æ§‡ØÅ ‡Æï‡Øà‡ÆÆ‡ØÅ‡Æ±‡Øà‡ÆØ‡Ææ‡Æï ‡Æâ‡Æ≥‡Øç‡Æ≥‡Æø‡Æü‡Æµ‡ØÅ‡ÆÆ‡Øç.",
                btnConfirm: "‡Æâ‡Æ±‡ØÅ‡Æ§‡Æø‡Æ™‡Øç‡Æ™‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡Æµ‡ØÅ‡ÆÆ‡Øç",
                fetching: "‡Æ§‡Æ∞‡Æµ‡ØÅ‡Æï‡Æ≥‡Øà‡Æ§‡Øç ‡Æ§‡Øá‡Æü‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ...",
                ready: "‡ÆÖ‡Æ±‡Æø‡Æï‡Øç‡Æï‡Øà ‡Æ§‡ÆØ‡Ææ‡Æ∞‡Øç! ‡Æ§‡Æø‡Æ±‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ...",
                btnDone: "‡Æö‡ÆÆ‡Æ∞‡Øç‡Æ™‡Øç‡Æ™‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç"
            }
        };

        const delay = ms => new Promise(res => setTimeout(res, ms));

        function scrollToBottom() {
            setTimeout(() => {
                chatBody.scrollTop = chatBody.scrollHeight + 100;
            }, 50);
        }

        window.onload = function() {
            const savedLang = localStorage.getItem('biotech_assistant_lang');
            if (savedLang && i18n[savedLang]) {
                initApp(savedLang);
            } else {
                document.getElementById('langModal').classList.remove('hidden');
            }
        };

        function saveAndInit(lang) {
            localStorage.setItem('biotech_assistant_lang', lang);
            initApp(lang);
        }

        function resetLanguage() {
            localStorage.removeItem('biotech_assistant_lang');
            localStorage.removeItem('biotech_chat_history'); // Clear history on language switch
            location.reload();
        }

        function initApp(lang) {
            currentLang = lang;
            document.getElementById('langModal').classList.add('hidden');

            // Render Past History if it exists to prompt continuation
            if (chatHistory.length > 0) {
                chatHistory.forEach(msg => {
                    const div = document.createElement('div');
                    div.className = `msg msg-${msg.sender}`;
                    div.dataset.msgId = msg.id; 
                    div.innerHTML = msg.content;
                    chatBody.appendChild(div);
                });

                // Disable all historical interactive elements so they can't be misclicked
                const oldElements = chatBody.querySelectorAll('.option-btn, input, button, select, label');
                oldElements.forEach(el => {
                    el.removeAttribute('onclick');
                    el.removeAttribute('for');
                    el.classList.add('opacity-60', 'pointer-events-none');
                    if (el.tagName === 'INPUT' || el.tagName === 'SELECT') {
                        el.disabled = true;
                    }
                });

                scrollToBottom();

                // Intercept with a prompt to Continue or Start New
                let welcomeBackStr = savedPatientName 
                    ? i18n[currentLang].welcomeBack.replace('{name}', savedPatientName) 
                    : i18n[currentLang].welcomeBackGen;

                const promptHtml = `
                    <div class="mb-2 font-medium text-teal-900">${welcomeBackStr}</div>
                    <div class="flex flex-col gap-2 mt-3">
                        <button onclick="resumeChat(false)" class="w-full bg-teal-600 text-white py-3 rounded-xl font-bold transition hover:bg-teal-700 shadow-md">
                            ${i18n[currentLang].btnContinue} <i class="fa-solid fa-arrow-right ml-1"></i>
                        </button>
                        <button onclick="resumeChat(true)" class="w-full bg-white border-2 border-teal-200 text-teal-700 py-3 rounded-xl font-bold transition hover:bg-teal-50 shadow-sm">
                            ${i18n[currentLang].btnNewChat} <i class="fa-solid fa-broom ml-1"></i>
                        </button>
                    </div>
                `;
                
                // Temporary DOM element (not saved to history)
                const promptDiv = document.createElement('div');
                promptDiv.className = `msg msg-bot temp-prompt`;
                promptDiv.innerHTML = promptHtml;
                chatBody.appendChild(promptDiv);
                scrollToBottom();

            } else {
                // Fresh start
                let greetingMsg = i18n[currentLang].welcome;
                addMessage(greetingMsg, 'bot');
                setTimeout(() => step0_Method(), 800);
            }
        }

        // Handles what happens after user selects Continue or New Chat
        function resumeChat(clearHistory) {
            const temp = document.querySelector('.temp-prompt');
            if (temp) temp.remove();

            if (clearHistory) {
                chatHistory = [];
                localStorage.removeItem('biotech_chat_history');
                chatBody.innerHTML = '';
                
                let greetingMsg = savedPatientName 
                    ? i18n[currentLang].welcomeBack.replace('{name}', savedPatientName) 
                    : i18n[currentLang].welcome;
                    
                addMessage(greetingMsg, 'bot');
                setTimeout(() => step0_Method(), 600);
            } else {
                const divider = document.createElement('div');
                divider.className = "text-center text-teal-600/50 text-xs font-bold my-4 uppercase tracking-widest";
                divider.innerText = "--- Continued Session ---";
                chatBody.appendChild(divider);
                
                setTimeout(() => step0_Method(), 400);
            }
        }

        // --- Memory & History Engine ---
        function addMessage(content, sender) {
            const div = document.createElement('div');
            div.className = `msg msg-${sender}`;
            div.innerHTML = content;
            
            // Unique ID to keep track for live UI updates
            const msgId = 'msg_' + Date.now() + Math.floor(Math.random() * 1000);
            div.dataset.msgId = msgId;

            chatBody.appendChild(div);
            scrollToBottom();

            // Push to memory array
            chatHistory.push({ id: msgId, content: content, sender: sender });
            saveHistory();

            return div;
        }

        function updateMessageHistory(divElement) {
            if(!divElement) return;
            const msgId = divElement.dataset.msgId;
            const msgIndex = chatHistory.findIndex(m => m.id === msgId);
            if (msgIndex !== -1) {
                // Update history with finalized HTML state (e.g., after loading dots resolve)
                chatHistory[msgIndex].content = divElement.innerHTML;
                saveHistory();
            }
        }

        function saveHistory() {
            // Keep only the last 30 messages to prevent infinite storage bloat
            if (chatHistory.length > 30) chatHistory = chatHistory.slice(-30);
            localStorage.setItem('biotech_chat_history', JSON.stringify(chatHistory));
        }

        // --- Process Flows ---

        function step0_Method() {
            // Mobile Fix: Unique ID for the file input on every new generation so it doesn't conflict with history
            const uniqueUploadId = 'billUpload_' + Date.now();
            
            const html = `
                <div>
                    ${i18n[currentLang].askMethod}
                    <div class="flex flex-col gap-3 mt-4">
                        <input type="file" id="${uniqueUploadId}" accept="image/*" style="display:none;" onchange="handleFileUpload(event)">
                        
                        <div class="option-btn !bg-teal-50 !border-teal-200 !text-teal-700 w-full flex items-center justify-center gap-2" onclick="document.getElementById('${uniqueUploadId}').click()">
                            <i class="fa-solid fa-camera-retro text-lg"></i> ${i18n[currentLang].btnUpload}
                        </div>
                        
                        <div class="option-btn w-full flex items-center justify-center gap-2" onclick="selectMethod('manual')">
                            <i class="fa-solid fa-keyboard text-lg"></i> ${i18n[currentLang].btnManual}
                        </div>
                    </div>
                </div>
            `;
            addMessage(html, 'bot');
        }

        function selectMethod(method) {
            if (method === 'manual') {
                addMessage(`<i class="fa-solid fa-keyboard mr-2"></i> ${i18n[currentLang].btnManual}`, 'user');
                setTimeout(() => step1_Type(), 600);
            }
        }

        function preprocessImage(base64Str) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width * 1.5;
                    canvas.height = img.height * 1.5;
                    ctx.filter = 'grayscale(100%) contrast(250%) brightness(120%)';
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg', 1.0));
                };
                img.src = base64Str;
            });
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Lock previous UI choices
            const wrapperDiv = event.target.closest('.msg');
            if (wrapperDiv) {
                wrapperDiv.classList.add('opacity-70', 'pointer-events-none');
                updateMessageHistory(wrapperDiv);
            }

            const reader = new FileReader();
            reader.onload = async function(e) {
                const base64Img = e.target.result;
                
                addMessage(`
                    <div class="flex items-center gap-2 mb-2">
                        <i class="fa-solid fa-file-image"></i> Bill Uploaded
                    </div>
                    <img src="${base64Img}" class="w-full max-h-32 object-cover rounded-lg border-2 border-white/20" />
                `, 'user');

                await delay(600);
                startScanningAnimation(base64Img);
            };
            reader.readAsDataURL(file);
            event.target.value = ''; // Allow re-upload of same file
        }

        async function startScanningAnimation(originalBase64Img) {
            const textStatusId = 'status_' + Date.now();

            const html = `
                <div class="w-full">
                    <div class="relative overflow-hidden rounded-xl border border-teal-200 bg-slate-800 shadow-inner">
                        <img src="${originalBase64Img}" class="w-full h-36 object-cover opacity-60 grayscale-[30%]">
                        <div class="scanner-line"></div>
                        <div class="absolute inset-0 bg-teal-500 mix-blend-overlay opacity-20"></div>
                    </div>
                    <div id="${textStatusId}" class="mt-3 text-sm font-bold text-teal-700 flex items-center justify-center h-6 transition-all duration-300">
                        <div class="typing-dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
                    </div>
                </div>
            `;
            
            const scanMsgDiv = addMessage(html, 'bot');
            const statusEl = document.getElementById(textStatusId);

            try {
                const processedBase64 = await preprocessImage(originalBase64Img);
                
                const worker = await Tesseract.createWorker('eng');
                const ret = await worker.recognize(processedBase64);
                const textStr = ret.data.text.toLowerCase();
                await worker.terminate();

                await delay(2000); 
                
                const isBiotec = /biotec|biotech/i.test(textStr);
                const isVeyangodaLab = /veyangoda/i.test(textStr) && /lab|laboratory/i.test(textStr);
                const isPatientReceipt = /patient\s*receipt/i.test(textStr);
                
                const isValidBill = isBiotec || isVeyangodaLab || isPatientReceipt;

                if (!isValidBill) { 
                    statusEl.innerHTML = `<i class="fa-solid fa-circle-xmark text-red-500 mr-2 text-lg"></i> <span class="text-red-600">Verification Failed</span>`;
                    updateMessageHistory(scanMsgDiv);
                    
                    addMessage(i18n[currentLang].rejectMsg, 'bot');
                    setTimeout(() => step0_Method(), 3500); 
                    return;
                }

                statusEl.innerHTML = `<i class="fa-solid fa-check-double text-green-500 mr-2 text-lg"></i> <span class="text-green-600">Scan Complete!</span>`;
                updateMessageHistory(scanMsgDiv); // Save completed scan state
                await delay(800);

                let extractedType = 'VG'; 
                let extractedNum = '';

                const explicitSampleMatch = textStr.match(/sample\s*no[\s\S]{0,20}?(vg|bn|ni|br)[\s\:\.\-]*(\d{1,6})/i);
                const combinedMatch = textStr.match(/(vg|bn|ni|br)[\s\:\.\-]*(\d{1,6})/i);

                if (explicitSampleMatch) {
                    extractedType = explicitSampleMatch[1].replace(/[\s\.]/g, '').toUpperCase();
                    extractedNum = explicitSampleMatch[2];
                } else if (combinedMatch) {
                    extractedType = combinedMatch[1].replace(/[\s\.]/g, '').toUpperCase();
                    extractedNum = combinedMatch[2];
                }

                formData.type = extractedType;
                formData.num = extractedNum;

                let dateStringToParse = '';
                const explicitDateMatch = textStr.match(/date[\s\:\.]*([\d\/\-\.]{8,10})/i);
                
                if (explicitDateMatch) {
                    dateStringToParse = explicitDateMatch[1];
                } else {
                    const fallbackDateMatch = textStr.match(/\b(\d{1,4}[\/\-\.]\d{1,2}[\/\-\.]\d{1,4})\b/);
                    if (fallbackDateMatch) dateStringToParse = fallbackDateMatch[1];
                }

                if (dateStringToParse) {
                    const dMatch2 = dateStringToParse.match(/\b(\d{4})[\/\-\.](\d{1,2})[\/\-\.](\d{1,2})\b/);
                    const dMatch1 = dateStringToParse.match(/\b(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})\b/);
                    
                    if (dMatch2) {
                        let y = dMatch2[1];
                        let m = dMatch2[2].padStart(2, '0');
                        let d = dMatch2[3].padStart(2, '0');
                        formData.date = `${y}-${m}-${d}`;
                    } else if (dMatch1) {
                        let d = dMatch1[1].padStart(2, '0');
                        let m = dMatch1[2].padStart(2, '0');
                        let y = dMatch1[3];
                        if (y.length === 2) y = "20" + y; 
                        formData.date = `${y}-${m}-${d}`;
                    } else {
                        formData.date = new Date().toISOString().split('T')[0]; 
                    }
                } else {
                    formData.date = new Date().toISOString().split('T')[0];
                }

                // 4. Patient Name Extraction
                let patientName = '';
                const nameMatch = textStr.match(/patient[\s\:\.]+([a-z\.\s]{3,40}?)(?=\s+age|\n|\s+\d)/i);
                
                if (nameMatch && nameMatch[1]) {
                    patientName = nameMatch[1].replace(/[\n\r]/g, ' ').trim().replace(/\b\w/g, c => c.toUpperCase());
                    formData.patientName = patientName;
                    
                    // SAVE PATIENT NAME TO LOCAL STORAGE SECURELY
                    savedPatientName = patientName;
                    localStorage.setItem('biotech_patient_name', savedPatientName);
                }

                const editFormId = 'edit_' + Date.now();
                let greetingHtml = '';
                
                if (patientName) {
                    const localizedGreeting = i18n[currentLang].greeting.replace('{name}', patientName);
                    greetingHtml = `
                        <div class="mb-3 text-teal-800 font-medium border-b border-teal-100 pb-3">
                            <i class="fa-solid fa-user-check mr-2 text-teal-600"></i> ${localizedGreeting}
                        </div>
                    `;
                }

                addMessage(`
                    <div id="${editFormId}" class="bg-teal-50/80 p-4 rounded-xl border border-teal-200 text-[15px] flex flex-col gap-3 shadow-sm">
                        
                        ${greetingHtml}
                        <p class="font-medium text-teal-900 mb-1">${i18n[currentLang].reviewMsg}</p>
                        
                        <div>
                            <label class="text-[11px] text-teal-600 font-bold uppercase tracking-wider">Sample Type</label>
                            <select id="edit_type_${editFormId}" class="custom-input !py-2 !bg-white mt-1">
                                <option value="VG" ${formData.type === 'VG' ? 'selected' : ''}>VG</option>
                                <option value="BN" ${formData.type === 'BN' ? 'selected' : ''}>BN</option>
                                <option value="NI" ${formData.type === 'NI' ? 'selected' : ''}>NI</option>
                                <option value="BR" ${formData.type === 'BR' ? 'selected' : ''}>BR</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="text-[11px] text-teal-600 font-bold uppercase tracking-wider">Sample Number</label>
                            <input type="number" id="edit_num_${editFormId}" value="${formData.num}" class="custom-input !py-2 !bg-white mt-1" placeholder="0000">
                        </div>
                        
                        <div>
                            <label class="text-[11px] text-teal-600 font-bold uppercase tracking-wider">Date</label>
                            <input type="date" id="edit_date_${editFormId}" value="${formData.date}" class="custom-input !py-2 !bg-white mt-1">
                        </div>
                        
                        <div class="flex flex-col gap-2 mt-2">
                            <button onclick="confirmEdits('${editFormId}')" class="w-full bg-teal-600 text-white py-3 rounded-xl font-bold transition hover:bg-teal-700 shadow-md">
                                ${i18n[currentLang].btnYes} <i class="fa-solid fa-check ml-1"></i>
                            </button>
                            <button onclick="retakePhoto('${editFormId}')" class="w-full bg-white border-2 border-teal-200 text-teal-700 py-3 rounded-xl font-bold transition hover:bg-teal-50 shadow-sm">
                                ${i18n[currentLang].btnRetake} <i class="fa-solid fa-camera ml-1"></i>
                            </button>
                        </div>
                    </div>
                `, 'bot');

            } catch (error) {
                console.error("OCR Error:", error);
                statusEl.innerHTML = `<i class="fa-solid fa-triangle-exclamation text-amber-500 mr-2"></i> Scan Error`;
                updateMessageHistory(scanMsgDiv);
                
                addMessage("An error occurred during scanning. Let's try manual entry instead.", 'bot');
                setTimeout(() => step0_Method(), 2000);
            }
        }

        function retakePhoto(formId) {
            const container = document.getElementById(formId);
            container.classList.add('opacity-50', 'pointer-events-none');
            updateMessageHistory(container.closest('.msg')); 
            
            addMessage(`<i class="fa-solid fa-camera mr-2"></i> ${i18n[currentLang].btnRetake}`, 'user');
            setTimeout(() => step0_Method(), 600);
        }

        function confirmEdits(formId) {
            const typeInput = document.getElementById(`edit_type_${formId}`);
            const numInput = document.getElementById(`edit_num_${formId}`);
            const dateInput = document.getElementById(`edit_date_${formId}`);
            const container = document.getElementById(formId);

            if (!numInput.value || numInput.value.length < 1) {
                numInput.classList.add('input-error', 'animate-shake');
                setTimeout(() => numInput.classList.remove('animate-shake'), 400);
                return;
            }

            formData.type = typeInput.value;
            formData.num = numInput.value;
            formData.date = dateInput.value;

            typeInput.disabled = true;
            numInput.disabled = true;
            dateInput.disabled = true;
            container.classList.add('opacity-70');
            container.querySelector('.flex.flex-col.gap-2.mt-2').remove(); 
            
            updateMessageHistory(container.closest('.msg'));

            setTimeout(() => step4_Phone(), 400);
        }

        // --- Manual Flow Functions ---

        function step1_Type() {
            const html = `
                <div>
                    ${i18n[currentLang].askType}
                    <div class="option-grid">
                        <div class="option-btn" onclick="selectType('VG')">VG</div>
                        <div class="option-btn" onclick="selectType('BN')">BN</div>
                        <div class="option-btn" onclick="selectType('NI')">NI</div>
                        <div class="option-btn" onclick="selectType('BR')">BR</div>
                    </div>
                </div>
            `;
            addMessage(html, 'bot');
        }

        function selectType(val) {
            formData.type = val;
            addMessage(val, 'user');
            setTimeout(() => step2_Num(), 600);
        }

        function step2_Num() {
            const id = 'num_' + Date.now();
            const html = `
                <div>
                    ${i18n[currentLang].askNum}
                    <div class="mt-4 flex gap-2">
                        <input type="number" id="${id}" class="custom-input" placeholder="0000" autofocus>
                        <button onclick="submitNum('${id}')" class="bg-teal-600 text-white w-14 rounded-2xl shadow-lg shadow-teal-200 transition hover:bg-teal-700"><i class="fa-solid fa-arrow-right"></i></button>
                    </div>
                </div>
            `;
            addMessage(html, 'bot');
            setTimeout(() => document.getElementById(id).focus(), 100);
        }

        function submitNum(id) {
            const input = document.getElementById(id);
            if(!input.value) return;
            formData.num = input.value;
            input.disabled = true;
            
            const wrapperDiv = input.closest('.msg');
            if(wrapperDiv) updateMessageHistory(wrapperDiv);

            addMessage(input.value, 'user');
            setTimeout(() => step3_Date(), 600);
        }

        function step3_Date() {
            const id = 'date_' + Date.now();
            const today = new Date().toISOString().split('T')[0];
            const html = `
                <div>
                    ${i18n[currentLang].askDate}
                    <div class="mt-4 flex gap-2">
                        <input type="date" id="${id}" value="${today}" class="custom-input">
                        <button onclick="submitDate('${id}')" class="bg-teal-600 text-white w-14 rounded-2xl shadow-lg shadow-teal-200 transition hover:bg-teal-700"><i class="fa-solid fa-arrow-right"></i></button>
                    </div>
                </div>
            `;
            addMessage(html, 'bot');
        }

        function submitDate(id) {
            const input = document.getElementById(id);
            formData.date = input.value;
            input.disabled = true;
            
            const wrapperDiv = input.closest('.msg');
            if(wrapperDiv) updateMessageHistory(wrapperDiv);

            addMessage(input.value, 'user');
            setTimeout(() => step4_Phone(), 600);
        }

        // --- Universal End Step ---

        function step4_Phone() {
            const id = 'phone_' + Date.now();
            const html = `
                <div>
                    ${i18n[currentLang].askPhone}
                    <div class="mt-4 flex gap-2">
                        <input type="tel" id="${id}" class="custom-input" placeholder="07XXXXXXXX" maxlength="10">
                        <button onclick="submitFinal('${id}')" class="bg-teal-700 text-white px-6 rounded-2xl font-bold uppercase text-xs tracking-widest transition hover:bg-teal-800 shadow-md">${i18n[currentLang].btnDone}</button>
                    </div>
                </div>
            `;
            addMessage(html, 'bot');
            setTimeout(() => document.getElementById(id).focus(), 100);
        }

        function submitFinal(id) {
            const input = document.getElementById(id);
            const phone = input.value.trim();
            
            const isValid = /^0\d{9}$/.test(phone);
            
            if (!isValid) {
                input.classList.add('animate-shake', 'input-error');
                setTimeout(() => input.classList.remove('animate-shake'), 400);
                addMessage(i18n[currentLang].phoneError, 'bot');
                return;
            }

            input.classList.remove('input-error');
            formData.phone = phone;
            input.disabled = true;
            
            const wrapperDiv = input.closest('.msg');
            if(wrapperDiv) updateMessageHistory(wrapperDiv);

            addMessage(phone, 'user');
            
            showLoadingFlow();
        }

        async function showLoadingFlow() {
            const loadingMsgDiv = addMessage(`<div class="typing-dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>`, 'bot');
            
            const params = new URLSearchParams({
                type: formData.type,
                sampleNumber: formData.num,
                date: formData.date,
                phone: formData.phone,
                language: currentLang,
                timestamp: new Date().toLocaleString()
            });

            fetch(`${scriptURL}?${params.toString()}`, {
                method: 'GET',
                mode: 'no-cors'
            }).catch(err => console.log("Logging suppressed or failed", err));

            setTimeout(() => {
                loadingMsgDiv.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin mr-2 text-teal-600"></i> ${i18n[currentLang].fetching}`;
                updateMessageHistory(loadingMsgDiv);
                
                setTimeout(() => {
                    loadingMsgDiv.innerHTML = `<i class="fa-solid fa-circle-check text-green-500 mr-2"></i> ${i18n[currentLang].ready}`;
                    updateMessageHistory(loadingMsgDiv);
                    
                    const patientId = formData.type + formData.num;
                    const expiry = new Date().getTime() + (14 * 24 * 60 * 60 * 1000);
                    const encoded = btoa(`${patientId}|${formData.date}|${expiry}`);
                    const finalUrl = `https://biotechveyangoda.lk/report-preview.html?data=${encoded}`;

                    setTimeout(() => {
                        window.location.href = finalUrl;
                    }, 1200);

                }, 2000);
            }, 1200);
        }
    </script>
</body>
</html>
