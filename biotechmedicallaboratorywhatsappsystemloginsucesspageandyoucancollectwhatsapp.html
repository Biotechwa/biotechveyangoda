<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biotech Laboratory | Admin Portal</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            /* TODO: Change to your local image path */
            background-image: linear-gradient(rgba(17, 24, 39, 0.7), rgba(17, 24, 39, 0.7)), url('https://images.unsplash.com/photo-1532094349884-543bc11b234d?q=80&w=2070&auto=format&fit=crop'); 
            
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: #333;
        }

        /* Custom Scrollbar */
        .history-scroll::-webkit-scrollbar { width: 6px; }
        .history-scroll::-webkit-scrollbar-track { background: rgba(255,255,255,0.1); }
        .history-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 3px; }
        .history-scroll::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.5); }

        /* Phone Input Overrides */
        .iti { width: 100%; }
        .iti__flag { background-image: url("https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/img/flags.png"); }
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
          .iti__flag { background-image: url("https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/img/flags@2x.png"); }
        }

        /* --- Animations --- */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse-glow {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); }
        }

        .animate-enter { animation: fadeInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; }
        .delay-1 { animation-delay: 0.1s; }
        .delay-2 { animation-delay: 0.2s; }
        
        .microscope-icon { transition: transform 0.3s ease; }
        .logo-container:hover .microscope-icon { transform: rotate(15deg) scale(1.1); }

        .glass-sidebar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        
        /* Error Message Animation */
        .shake { animation: shake 0.5s; }
        @keyframes shake {
          0% { transform: translateX(0); }
          25% { transform: translateX(-5px); }
          50% { transform: translateX(5px); }
          75% { transform: translateX(-5px); }
          100% { transform: translateX(0); }
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <aside class="w-80 glass-sidebar border-r border-gray-200 hidden md:flex flex-col z-10 shadow-2xl animate-enter">
        <div class="p-6 border-b border-gray-200 bg-teal-700 text-white logo-container cursor-pointer">
            <div class="flex flex-col items-center justify-center gap-3 mb-2">
                <div class="bg-white/20 p-4 rounded-full backdrop-blur-sm shadow-inner border border-white/10">
                    <i class="fa-solid fa-microscope text-4xl text-white microscope-icon"></i>
                </div>
                <h2 class="text-xl font-bold tracking-wide">BIOTECH LABORATORY</h2>
            </div>
            <div class="text-center">
                <p class="text-xs text-teal-100 bg-teal-800/50 py-1 px-3 rounded-full inline-block border border-teal-600">
                    <i class="fa-solid fa-bolt text-yellow-400 mr-1"></i> Admin Portal
                </p>
            </div>
        </div>
        
        <div class="p-4 bg-gray-50/80 border-b border-gray-200">
            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider flex items-center gap-2">
                <i class="fa-solid fa-clock-rotate-left"></i> Recent Reports
            </h3>
        </div>

        <div class="flex-1 overflow-y-auto p-4 history-scroll space-y-3" id="sentItemsList">
            </div>

        <div class="p-4 border-t border-gray-200 bg-gray-50/80">
            <button onclick="clearSentItems()" class="w-full py-2 px-4 bg-white text-red-500 hover:bg-red-50 hover:text-red-600 border border-red-100 rounded-lg text-sm font-semibold transition-all hover:shadow-md flex items-center justify-center gap-2 group">
                <i class="fa-solid fa-trash-can group-hover:scale-110 transition-transform"></i> Clear History
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-screen overflow-y-auto relative">
        <div class="md:hidden bg-teal-700 text-white p-4 flex justify-between items-center shadow-md z-20 relative">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-microscope text-xl"></i>
                <span class="font-bold text-lg tracking-wide">Biotech Lab</span>
            </div>
            <button onclick="toggleMobileHistory()" class="text-white p-2 bg-white/10 rounded-lg hover:bg-white/20 transition">
                <i class="fa-solid fa-clock-rotate-left"></i>
            </button>
        </div>

        <div id="mobileHistory" class="fixed inset-0 bg-black/80 z-40 hidden backdrop-blur-sm" onclick="toggleMobileHistory()">
            <div class="absolute right-0 top-0 h-full w-80 bg-white shadow-2xl p-4 overflow-y-auto animate-enter" onclick="event.stopPropagation()">
                <div class="flex justify-between items-center mb-6 pb-4 border-b">
                    <h3 class="font-bold text-gray-800 flex items-center gap-2">
                        <i class="fa-solid fa-list text-teal-600"></i> History
                    </h3>
                    <button onclick="toggleMobileHistory()" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times text-xl"></i></button>
                </div>
                <div id="sentItemsListMobile"></div>
                <button onclick="clearSentItems()" class="w-full mt-6 py-3 bg-red-50 text-red-600 rounded-xl font-medium border border-red-100">Clear All Data</button>
            </div>
        </div>

        <div class="flex-1 p-4 md:p-8 lg:p-12 flex justify-center items-start">
            <div class="w-full max-w-6xl grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12">
                
                <div class="bg-white/95 backdrop-blur-md rounded-3xl shadow-2xl border border-white/50 p-6 md:p-10 animate-enter delay-1 transform hover:scale-[1.01] transition-transform duration-500">
                    <div class="mb-8">
                        <div class="inline-flex items-center justify-center w-12 h-12 rounded-xl bg-teal-100 text-teal-600 mb-4 shadow-sm">
                            <i class="fa-solid fa-file-medical text-xl"></i>
                        </div>
                        <h1 class="text-3xl font-bold text-gray-800">BIOTECH WHATSAPP SYSTEM</h1>
                        <p class="text-sm text-gray-500 mt-1">Enter patient details to generate the secure WhatsApp link.</p>
                    </div>

                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-bold text-gray-600 mb-2 uppercase tracking-wider text-xs">Patient ID</label>
                            <div class="flex gap-3 group">
                                <select id="vgSelection" class="w-1/3 p-4 bg-gray-50 border border-gray-200 rounded-xl focus:ring-4 focus:ring-teal-500/20 focus:border-teal-500 outline-none font-bold text-gray-700 cursor-pointer transition-all hover:bg-white">
                                    <option value="BN">BN</option>
                                    <option value="VG">VG</option>
                                    <option value="NI">NI</option>
                                    <option value="BR">BR</option>
                                </select>
                                <input type="number" id="vgNum" placeholder="1" class="w-2/3 p-4 bg-gray-50 border border-gray-200 rounded-xl focus:ring-4 focus:ring-teal-500/20 focus:border-teal-500 outline-none transition-all font-mono text-lg hover:bg-white" />
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-600 mb-2 uppercase tracking-wider text-xs">Report Date</label>
                            <div class="relative group">
                                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                    <i class="fa-regular fa-calendar text-teal-500 group-focus-within:text-teal-600 transition-colors"></i>
                                </div>
                                <input type="date" id="date" class="w-full pl-12 p-4 bg-gray-50 border border-gray-200 rounded-xl focus:ring-4 focus:ring-teal-500/20 focus:border-teal-500 outline-none transition-all text-gray-700 font-medium hover:bg-white" />
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-600 mb-2 uppercase tracking-wider text-xs">WhatsApp Number</label>
                            <input type="tel" id="phoneNum" placeholder="767810623" maxlength="11" class="w-full p-4 bg-gray-50 border border-gray-200 rounded-xl focus:ring-4 focus:ring-teal-500/20 focus:border-teal-500 outline-none transition-all hover:bg-white" />
                            <div id="phoneError" class="text-red-500 text-xs mt-2 font-bold hidden flex items-center gap-1">
                                <i class="fa-solid fa-circle-exclamation"></i> Only 9 digits allowed (e.g. 767810623)
                            </div>
                        </div>

                        <div class="pt-6">
                            <button onclick="sendWhatsApp()" id="sendBtn" style="animation: pulse-glow 2s infinite;" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold py-4 rounded-2xl shadow-lg shadow-green-500/30 transform hover:-translate-y-1 transition-all flex justify-center items-center gap-3 group opacity-50 cursor-not-allowed">
                                <i class="fa-brands fa-whatsapp text-2xl group-hover:rotate-12 transition-transform"></i>
                                <span class="text-lg">Send Report Link</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="bg-white/95 backdrop-blur-md rounded-3xl shadow-2xl border border-white/50 flex flex-col overflow-hidden animate-enter delay-2">
                    <div class="bg-gradient-to-r from-gray-50 to-gray-100 p-5 border-b border-gray-200 flex justify-between items-center">
                        <span class="font-bold text-gray-600 flex items-center gap-2">
                            <i class="fa-regular fa-eye text-teal-500"></i> Live Preview
                        </span>
                        <button onclick="copyLinkOnly()" class="text-xs font-semibold bg-white border border-gray-300 px-4 py-2 rounded-lg hover:bg-teal-50 hover:text-teal-600 hover:border-teal-200 transition shadow-sm flex items-center gap-2">
                            <i class="fa-solid fa-link"></i> Copy Link Only
                        </button>
                    </div>
                    
                    <div class="flex-1 p-0 relative group">
                        <textarea id="messagePreview" readonly class="w-full h-full p-8 bg-white text-gray-700 text-sm resize-none focus:outline-none font-mono leading-relaxed min-h-[300px] selection:bg-teal-100"></textarea>
                        <div class="absolute bottom-4 right-4 pointer-events-none opacity-10">
                            <i class="fa-brands fa-whatsapp text-8xl text-teal-900"></i>
                        </div>
                    </div>

                    <div class="bg-gray-50 p-4 text-xs text-center text-gray-400 border-t border-gray-200 font-medium tracking-wide">
                        SYSTEM DEVELOPED BY <a href="wa.me/94767810623">Theekshana</a>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js"></script>
    <script>
        let iti = null;
        // Helper variable to store the raw 9 digit number
        let finalRawNumber = "";

        document.addEventListener("DOMContentLoaded", function() {
            document.getElementById('date').valueAsDate = new Date();

            const phoneInput = document.getElementById("phoneNum");
            
            // Initialize intl-tel-input
            iti = window.intlTelInput(phoneInput, {
                initialCountry: "lk",
                separateDialCode: true,
                autoPlaceholder: "off",
                utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js"
            });

            // --- CUSTOM PHONE NUMBER LOGIC START ---
            phoneInput.addEventListener('input', function(e) {
                const errorDiv = document.getElementById('phoneError');
                let val = e.target.value;

                // 1. Remove non-digit characters
                val = val.replace(/\D/g, '');

                // 2. Remove leading Zero if present
                if (val.startsWith('0')) {
                    val = val.substring(1);
                }

                // 3. Enforce Max 9 Digits
                if (val.length > 9) {
                    val = val.substring(0, 9);
                    // Trigger visual error shake
                    errorDiv.classList.remove('hidden');
                    errorDiv.classList.add('shake');
                    setTimeout(() => errorDiv.classList.remove('shake'), 500);
                } else {
                    errorDiv.classList.add('hidden');
                }

                // 4. Update the input field with clean value
                e.target.value = val;
                finalRawNumber = val; // Store clean number for sending

                updatePreview();
            });
            // --- CUSTOM PHONE NUMBER LOGIC END ---

            ['vgSelection', 'vgNum', 'date'].forEach(id => {
                document.getElementById(id).addEventListener('input', updatePreview);
            });
            
            displaySentItems();
            updatePreview();
        });

        function updatePreview() {
            const vgSelection = document.getElementById('vgSelection').value;
            const vgNum = document.getElementById('vgNum').value.trim();
            const date = document.getElementById('date').value;
            const sendBtn = document.getElementById('sendBtn');
            
            // STRICT CHECK: Only generate if phone number is exactly 9 digits
            if (vgNum && date && finalRawNumber.length === 9) {
                
                // Enable Button
                sendBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                
                const patientId = `${vgSelection}${vgNum}`;
                const originalData = `${patientId}|${date}`;
                const encodedData = btoa(originalData);
                const link = `https://biotechveyangoda.lk/report-preview.html?data=${encodedData}`;

                const message = `*Biotech Medical Laboratory Online Report*\n\n` + 
                              `ðŸ‘¤ *Patient ID:* ${patientId}\n` +
                              `ðŸ“… *Date:* ${date}\n\n` +
                              `â— Click the link below to view and download your report.\n` +
                              `*(à¶”à¶¶à¶§ à¶´à·„à¶½à·’à¶±à·Š à¶½à·’à¶±à·Šà¶šà·Š à¶‘à¶šà¶šà·Š à¶¯à·’à·ƒà·Š à¶±à·œà·€à·”à¶±à·„à·œà¶­à·Š à¶šà¶»à·”à¶«à·à¶šà¶» à¶…à¶´à¶œà·š WHATSAPP NUMBER à¶‘à¶š à·ƒà·šà·€à·Š à¶šà¶»à¶œà¶±à·Šà¶±.)*\n\n` +
                              `ðŸ‘‡\nðŸ”— ${link}\n\n` +
                              `ð™ð™§ð™¤ð™¢ - ð˜½ð™„ð™Šð™ð™€ð˜¾ð™ƒ ð™‡ð˜¼ð˜½ð™Šð™ð˜¼ð™ð™Šð™ð™”`;
                
                document.getElementById('messagePreview').value = message;
                return link;
            } else {
                // Disable Button
                sendBtn.classList.add('opacity-50', 'cursor-not-allowed');
                
                let warning = "Waiting for input...";
                if (finalRawNumber.length > 0 && finalRawNumber.length < 9) {
                    warning = `Number is too short (${finalRawNumber.length}/9 digits)...`;
                } else if (!vgNum) {
                    warning = "Enter Patient Number...";
                }
                
                document.getElementById('messagePreview').value = warning;
                return null;
            }
        }

        function sendWhatsApp() {
            // Final safety check
            if (finalRawNumber.length !== 9) {
                alert("Please enter a valid 9-digit phone number (e.g., 767810623).");
                return;
            }

            const message = document.getElementById("messagePreview").value;
            if (message.includes("Waiting for input") || message.includes("Number is too short")) {
                alert("Please fill all required fields correctly.");
                return;
            }

            const vgSelection = document.getElementById("vgSelection").value;
            const vgNum = document.getElementById("vgNum").value.trim();
            const date = document.getElementById("date").value;
            addSentItem(vgSelection, vgNum, date);

            // Construct valid international number: 94 + 9 digits
            const fullNumber = "94" + finalRawNumber;
            
            const encodedMessage = encodeURIComponent(message);
            const whatsappWebUrl = `https://web.whatsapp.com/send?phone=${fullNumber}&text=${encodedMessage}`;
            window.open(whatsappWebUrl, "_blank");
        }

        function copyLinkOnly() {
            const link = updatePreview();
            if(link) {
                navigator.clipboard.writeText(link).then(() => {
                    const btn = document.querySelector('button[onclick="copyLinkOnly()"]');
                    const originalHtml = btn.innerHTML;
                    btn.innerHTML = '<i class="fa-solid fa-check"></i> Copied!';
                    btn.classList.add('text-green-600', 'bg-green-50', 'border-green-200');
                    setTimeout(() => {
                        btn.innerHTML = originalHtml;
                        btn.classList.remove('text-green-600', 'bg-green-50', 'border-green-200');
                    }, 2000);
                });
            } else {
                alert("Please enter 9 digit phone number and patient details first.");
            }
        }

        function addSentItem(vgSelection, vgNum, date) {
            const now = new Date();
            const newItem = {
                id: `${vgSelection}${vgNum}`,
                date: date,
                sendTime: now.toLocaleTimeString("en-US", {hour: '2-digit', minute:'2-digit'}),
                timestamp: now.getTime()
            };
            
            const sentItems = JSON.parse(localStorage.getItem("biotechSentItems") || "[]");
            sentItems.unshift(newItem);
            if(sentItems.length > 50) sentItems.pop();
            localStorage.setItem("biotechSentItems", JSON.stringify(sentItems));
            displaySentItems();
        }

        function displaySentItems() {
            const sentItems = JSON.parse(localStorage.getItem("biotechSentItems") || "[]");
            const html = sentItems.length === 0 
                ? `<div class="text-center text-gray-400 text-sm mt-10 flex flex-col items-center opacity-60">
                    <i class="fa-regular fa-folder-open text-3xl mb-3"></i>
                    No items sent today
                   </div>`
                : sentItems.map((item, index) => `
                    <div style="animation-delay: ${index * 0.05}s" class="bg-white p-3 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition-shadow relative overflow-hidden group animate-enter cursor-default">
                        <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-gradient-to-b from-teal-400 to-teal-600"></div>
                        <div class="flex justify-between items-start pl-3">
                            <div>
                                <span class="font-bold text-gray-800 block tracking-wide">${item.id}</span>
                                <span class="text-xs text-gray-500 font-medium"><i class="fa-regular fa-calendar-check mr-1 text-teal-500"></i>${item.date}</span>
                            </div>
                            <span class="text-xs font-bold text-teal-700 bg-teal-50 px-2 py-1 rounded-md border border-teal-100">${item.sendTime}</span>
                        </div>
                    </div>
                  `).join("");

            document.getElementById("sentItemsList").innerHTML = html;
            const mobileList = document.getElementById("sentItemsListMobile");
            if(mobileList) mobileList.innerHTML = html;
        }

        function clearSentItems() {
            const password = prompt("Enter password to clear sent items:");
            if (password === "129876") {
                localStorage.removeItem("biotechSentItems");
                displaySentItems();
            } else if (password !== null) {
                alert("Incorrect password!");
            }
        }

        function toggleMobileHistory() {
            const el = document.getElementById('mobileHistory');
            el.classList.toggle('hidden');
        }
    </script>
</body>
</html>
