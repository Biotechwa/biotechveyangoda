<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Biotech Voice - Head Office</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap');
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #0f172a; 
            color: white;
            height: 100vh;
            overflow: hidden;
            touch-action: manipulation; 
        }

        /* Animations */
        .pulse-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            animation: pulse 2s infinite;
            border: 2px solid rgba(74, 222, 128, 0.5);
            opacity: 0;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        .shake-animation { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both infinite; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0) rotate(-1deg); } 20%, 80% { transform: translate3d(2px, 0, 0) rotate(1deg); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0) rotate(-4deg); } 40%, 60% { transform: translate3d(4px, 0, 0) rotate(4deg); } }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .btn-press:active { transform: scale(0.95); }
    </style>
</head>
<body class="flex flex-col">

    <!-- AUDIO ELEMENTS -->
    <audio id="ringtone" loop src="https://assets.mixkit.co/active_storage/sfx/1359/1359-preview.mp3"></audio>
    <audio id="remoteAudio" autoplay playsinline></audio>

    <!-- HEADER -->
    <div class="p-4 flex justify-between items-center glass z-10 safe-top">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-teal-500 flex items-center justify-center shadow-lg shadow-teal-500/30">
                <i class="fa-solid fa-building text-white text-xl"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg leading-tight">Biotech Voice</h1>
                <div class="flex items-center gap-1.5">
                    <div id="connectionDot" class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e]"></div>
                    <span id="myLocationLabel" class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">HEAD OFFICE</span>
                </div>
            </div>
        </div>
        <!-- Settings hidden since identity is hardcoded -->
        <div class="text-[10px] text-slate-500 font-mono">v2.0</div>
    </div>

    <!-- MAIN CONTENT AREA -->
    <main class="flex-1 relative w-full h-full">

        <!-- 1. DIALER SCREEN (Active Immediately) -->
        <div id="dialerScreen" class="absolute inset-0 p-6 flex flex-col">
            <div class="flex-1 grid grid-cols-2 gap-4 content-center">
                <!-- Buttons generated by JS -->
                
                <!-- NOTE: Head Office button removed since "I am Head Office" -->

                <button onclick="call('VEYANGODA')" class="glass rounded-2xl p-4 flex flex-col items-center justify-center gap-3 relative btn-press group">
                    <div class="w-14 h-14 rounded-full bg-slate-700 flex items-center justify-center group-hover:bg-slate-600 transition">
                        <span class="text-xl font-bold">VG</span>
                    </div>
                    <span class="font-bold text-sm">Veyangoda</span>
                    <div id="dot-VEYANGODA" class="absolute top-4 right-4 w-3 h-3 rounded-full bg-red-500 border-2 border-slate-800"></div>
                </button>

                <button onclick="call('BANDARANAYAKE')" class="glass rounded-2xl p-4 flex flex-col items-center justify-center gap-3 relative btn-press group">
                    <div class="w-14 h-14 rounded-full bg-slate-700 flex items-center justify-center group-hover:bg-slate-600 transition">
                        <span class="text-xl font-bold">BN</span>
                    </div>
                    <span class="font-bold text-sm">Bandaranayake</span>
                    <div id="dot-BANDARANAYAKE" class="absolute top-4 right-4 w-3 h-3 rounded-full bg-red-500 border-2 border-slate-800"></div>
                </button>

                <button onclick="call('Naiwala')" class="glass rounded-2xl p-4 flex flex-col items-center justify-center gap-3 relative btn-press group">
                    <div class="w-14 h-14 rounded-full bg-slate-700 flex items-center justify-center group-hover:bg-slate-600 transition">
                        <span class="text-xl font-bold">NI</span>
                    </div>
                    <span class="font-bold text-sm">Naiwala</span>
                    <div id="dot-Naiwala" class="absolute top-4 right-4 w-3 h-3 rounded-full bg-red-500 border-2 border-slate-800"></div>
                </button>

                <button onclick="call('BANDURAGODA')" class="glass rounded-2xl p-4 flex flex-col items-center justify-center gap-3 relative btn-press group">
                    <div class="w-14 h-14 rounded-full bg-slate-700 flex items-center justify-center group-hover:bg-slate-600 transition">
                        <span class="text-xl font-bold">BR</span>
                    </div>
                    <span class="font-bold text-sm">Banduragoda</span>
                    <div id="dot-BANDURAGODA" class="absolute top-4 right-4 w-3 h-3 rounded-full bg-red-500 border-2 border-slate-800"></div>
                </button>

                <button onclick="call('ADMIN')" class="glass rounded-2xl p-4 flex flex-col items-center justify-center gap-3 relative btn-press group border-teal-500/30">
                    <div class="w-14 h-14 rounded-full bg-teal-900 flex items-center justify-center group-hover:bg-teal-800 transition text-teal-400">
                        <i class="fa-solid fa-user-shield text-xl"></i>
                    </div>
                    <span class="font-bold text-sm text-teal-400">Admin</span>
                    <div id="dot-ADMIN" class="absolute top-4 right-4 w-3 h-3 rounded-full bg-red-500 border-2 border-slate-800"></div>
                </button>
            </div>
            <p class="text-center text-xs text-slate-500 mt-4"><i class="fa-solid fa-circle-info mr-1"></i> Running as Head Office</p>
        </div>

        <!-- 2. INCOMING CALL SCREEN -->
        <div id="incomingScreen" class="absolute inset-0 bg-slate-900 z-50 flex flex-col items-center justify-center hidden">
            <div class="absolute inset-0 flex items-center justify-center opacity-20">
                <div class="w-64 h-64 rounded-full bg-teal-500 animate-ping"></div>
            </div>

            <div class="relative z-10 flex flex-col items-center">
                <div class="w-24 h-24 rounded-full bg-slate-800 border-4 border-slate-700 flex items-center justify-center mb-6 shake-animation shadow-2xl">
                    <i class="fa-solid fa-phone text-4xl text-teal-400"></i>
                </div>
                <h2 class="text-xl text-slate-400 mb-1">Incoming Audio Call...</h2>
                <h1 id="incomingCallerName" class="text-3xl font-bold text-white mb-16">Unknown</h1>

                <div class="flex gap-10 w-full justify-center px-10">
                    <button onclick="rejectCall()" class="flex flex-col items-center gap-2">
                        <div class="w-16 h-16 rounded-full bg-red-500 flex items-center justify-center shadow-lg shadow-red-500/30 btn-press">
                            <i class="fa-solid fa-phone-slash text-2xl"></i>
                        </div>
                        <span class="text-xs font-bold text-slate-400">Decline</span>
                    </button>

                    <button onclick="answerCall()" class="flex flex-col items-center gap-2">
                        <div class="w-16 h-16 rounded-full bg-green-500 flex items-center justify-center shadow-lg shadow-green-500/30 btn-press animate-bounce">
                            <i class="fa-solid fa-phone text-2xl"></i>
                        </div>
                        <span class="text-xs font-bold text-slate-400">Accept</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- 3. ACTIVE CALL SCREEN -->
        <div id="activeScreen" class="absolute inset-0 bg-slate-900 z-40 flex flex-col items-center pt-20 hidden">
            <div class="w-32 h-32 rounded-full bg-slate-800 flex items-center justify-center mb-4 border border-slate-700 relative">
                <div class="pulse-ring"></div>
                <i class="fa-solid fa-user text-5xl text-slate-500"></i>
            </div>
            <h1 id="activeCallerName" class="text-2xl font-bold text-white mb-2">Connected</h1>
            <p id="callTimer" class="text-teal-400 font-mono text-lg mb-20">00:00</p>

            <p id="callStatus" class="text-sm text-slate-500 mb-10 animate-pulse">Voice Connected</p>

            <div class="w-full bg-slate-800 rounded-t-[3rem] flex-1 mt-auto p-8 flex flex-col items-center justify-center shadow-[0_-10px_40px_rgba(0,0,0,0.5)]">
                <div class="flex gap-8 mb-8">
                    <button onclick="toggleMute()" id="muteBtn" class="w-16 h-16 rounded-full bg-slate-700 flex items-center justify-center text-white btn-press">
                        <i class="fa-solid fa-microphone text-xl"></i>
                    </button>
                    <button class="w-16 h-16 rounded-full bg-slate-700 flex items-center justify-center text-white btn-press opacity-50">
                        <i class="fa-solid fa-volume-high text-xl"></i>
                    </button>
                </div>
                
                <button onclick="endCall()" class="w-20 h-20 rounded-full bg-red-500 flex items-center justify-center shadow-xl shadow-red-500/30 btn-press">
                    <i class="fa-solid fa-phone-slash text-3xl"></i>
                </button>
            </div>
        </div>

    </main>

    <!-- FIREBASE MODULE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, serverTimestamp, remove, onChildAdded, onDisconnect } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

        const voiceConfig = {
            apiKey: "AIzaSyCPYqMnRIapygJqaKe6JZpitF3E5fq8jIs",
            authDomain: "biotechchat-c0a38.firebaseapp.com",
            projectId: "biotechchat-c0a38",
            storageBucket: "biotechchat-c0a38.firebasestorage.app",
            messagingSenderId: "1081724102554",
            appId: "1:1081724102554:web:16b0c1ee763148b4a63c23"
        };

        const app = initializeApp(voiceConfig);
        const db = getDatabase(app);

        window.voiceDb = db;
        window.ref = ref;
        window.push = push;
        window.set = set;
        window.remove = remove;
        window.onDisconnect = onDisconnect;
        window.serverTimestamp = serverTimestamp;
        window.onValue = onValue;
        window.onChildAdded = onChildAdded;
    </script>

    <!-- APP LOGIC -->
    <script>
        // HARDCODED IDENTITY
        const myIdentity = "HEAD OFFICE"; 
        
        let localStream;
        let peerConnection;
        const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
        let currentCallRef = null;
        let callTimerInterval;
        let isMuted = false;
        let wakeLock = null;
        let candidateQueue = [];
        let disconnectTimer = null;

        // --- 1. INITIALIZATION ---
        document.addEventListener("DOMContentLoaded", () => {
            initApp();
            
            // Auto-ask permission on load for APK
            if ("Notification" in window) {
                Notification.requestPermission().then(perm => {
                    if(perm === 'granted') console.log("Notifications enabled");
                });
            }
            
            // Pre-request Mic access if possible (some browsers block this without gesture)
            // navigator.mediaDevices.getUserMedia({ audio: true }).catch(() => {});
        });

        async function requestWakeLock() {
            try {
                if('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                }
            } catch (err) { console.log("Wake Lock Error", err); }
        }

        function initApp() {
            // Start Presence & Listeners
            setTimeout(() => {
                if(window.setPresence) window.setPresence(myIdentity);
                if(window.listenForCalls) window.listenForCalls();
                if(window.monitorPresence) window.monitorPresence();
            }, 1500); 

            requestWakeLock();
            
            // Keep Wake Lock Active
            document.addEventListener('visibilitychange', async () => {
                if (wakeLock !== null && document.visibilityState === 'visible') {
                    requestWakeLock();
                }
            });
        }

        // --- 2. PRESENCE SYSTEM ---
        window.setPresence = (branchId) => {
            const presenceRef = window.ref(window.voiceDb, `biotech_presence/${branchId}`);
            window.set(presenceRef, { online: true, last_seen: window.serverTimestamp() });
            window.onDisconnect(presenceRef).remove();
        };

        window.monitorPresence = () => {
            window.onValue(window.ref(window.voiceDb, 'biotech_presence'), (snapshot) => {
                const presences = snapshot.val() || {};
                const branches = ['BANDARANAYAKE', 'VEYANGODA', 'BANDURAGODA', 'Naiwala', 'ADMIN']; // HO excluded as it is me
                
                branches.forEach(branch => {
                    const safeId = branch.replace(' ', '_');
                    const el = document.getElementById('dot-' + safeId);
                    if(el) {
                        const originalKey = branch.replace('_', ' '); 
                        const isOnline = presences[originalKey]?.online === true;
                        if(isOnline) el.className = "absolute top-4 right-4 w-3 h-3 rounded-full bg-green-500 border-2 border-slate-800 shadow-[0_0_8px_#22c55e]";
                        else el.className = "absolute top-4 right-4 w-3 h-3 rounded-full bg-red-500 border-2 border-slate-800";
                    }
                });
            });
        }

        // --- 3. CALL LOGIC ---
        window.call = async function(target) {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            } catch(e) { alert("Microphone blocked. Check APK permissions."); return; }

            peerConnection = new RTCPeerConnection(rtcConfig);
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            
            const audioEl = document.getElementById('remoteAudio');
            peerConnection.ontrack = event => { audioEl.srcObject = event.streams[0]; audioEl.play(); };

            peerConnection.oniceconnectionstatechange = () => {
                handleConnectionState(peerConnection.iceConnectionState);
            };

            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    window.push(window.ref(window.voiceDb, `biotech_calls/${target}/candidates`), {
                        candidate: JSON.stringify(event.candidate),
                        sender: myIdentity
                    });
                }
            };

            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);

            const callBase = `biotech_calls/${target}`;
            currentCallRef = window.ref(window.voiceDb, callBase);
            window.set(window.ref(window.voiceDb, `${callBase}/candidates`), null);

            window.set(window.ref(window.voiceDb, `${callBase}/offer`), {
                caller: myIdentity,
                sdp: JSON.stringify(peerConnection.localDescription),
                timestamp: window.serverTimestamp()
            });

            showActiveScreen(target, "Calling...");
            
            window.onValue(window.ref(window.voiceDb, `${callBase}/answer`), async (snapshot) => {
                const data = snapshot.val();
                if (data && !peerConnection.currentRemoteDescription) {
                    const desc = new RTCSessionDescription(JSON.parse(data.sdp));
                    await peerConnection.setRemoteDescription(desc);
                    while(candidateQueue.length > 0) {
                        peerConnection.addIceCandidate(candidateQueue.shift()).catch(e => console.log(e));
                    }
                }
            });

            window.onChildAdded(window.ref(window.voiceDb, `${callBase}/candidates`), (snapshot) => {
                const data = snapshot.val();
                if (data && data.sender !== myIdentity) {
                    const candidate = new RTCIceCandidate(JSON.parse(data.candidate));
                    if (peerConnection.remoteDescription) peerConnection.addIceCandidate(candidate).catch(e => console.log(e));
                    else candidateQueue.push(candidate);
                }
            });
        }

        window.listenForCalls = function() {
            const myOfferRef = window.ref(window.voiceDb, `biotech_calls/${myIdentity}/offer`);
            window.onValue(myOfferRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    // INCOMING CALL
                    document.getElementById('incomingCallerName').innerText = data.caller;
                    document.getElementById('incomingScreen').classList.remove('hidden');
                    
                    // Force ringtone play
                    const ring = document.getElementById('ringtone');
                    ring.currentTime = 0;
                    ring.play().catch(e=>console.log("Audio Play Error: ", e));
                    
                    // SYSTEM NOTIFICATION FOR APK
                    if (Notification.permission === "granted") {
                        // Vibrate phone
                        if(navigator.vibrate) navigator.vibrate([1000, 500, 1000, 500, 1000]);
                        
                        // Show System Notification
                        const n = new Notification("Incoming Biotech Call", {
                            body: `${data.caller} is calling Head Office.`,
                            icon: "https://cdn-icons-png.flaticon.com/512/724/724664.png",
                            tag: "biotech_call",
                            requireInteraction: true,
                            renotify: true
                        });
                        n.onclick = function() { window.focus(); this.close(); };
                    }

                } else {
                    document.getElementById('incomingScreen').classList.add('hidden');
                    document.getElementById('ringtone').pause();
                    document.getElementById('ringtone').currentTime = 0;
                }
            });
        };

        window.answerCall = async function() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            } catch(e) { alert("Mic Error"); return; }

            document.getElementById('ringtone').pause();
            
            peerConnection = new RTCPeerConnection(rtcConfig);
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            
            const audioEl = document.getElementById('remoteAudio');
            peerConnection.ontrack = event => { audioEl.srcObject = event.streams[0]; audioEl.play(); };

            peerConnection.oniceconnectionstatechange = () => {
                handleConnectionState(peerConnection.iceConnectionState);
            };

            const callBase = `biotech_calls/${myIdentity}`;
            currentCallRef = window.ref(window.voiceDb, callBase);

            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    window.push(window.ref(window.voiceDb, `${callBase}/candidates`), {
                        candidate: JSON.stringify(event.candidate),
                        sender: myIdentity
                    });
                }
            };
            
            window.onValue(window.ref(window.voiceDb, `${callBase}/offer`), async (snapshot) => {
                const data = snapshot.val();
                if (data && !peerConnection.currentRemoteDescription) {
                    showActiveScreen(data.caller, "Connecting...");
                    document.getElementById('incomingScreen').classList.add('hidden');

                    const remoteDesc = new RTCSessionDescription(JSON.parse(data.sdp));
                    await peerConnection.setRemoteDescription(remoteDesc);
                    
                    while(candidateQueue.length > 0) {
                        peerConnection.addIceCandidate(candidateQueue.shift()).catch(e => console.log(e));
                    }
                    
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    
                    window.set(window.ref(window.voiceDb, `${callBase}/answer`), {
                        sdp: JSON.stringify(answer),
                        timestamp: window.serverTimestamp()
                    });
                }
            }, { onlyOnce: true });

            window.onChildAdded(window.ref(window.voiceDb, `${callBase}/candidates`), (snapshot) => {
                const data = snapshot.val();
                if (data && data.sender !== myIdentity) {
                    const candidate = new RTCIceCandidate(JSON.parse(data.candidate));
                    if (peerConnection.remoteDescription) peerConnection.addIceCandidate(candidate).catch(e => console.log(e));
                    else candidateQueue.push(candidate);
                }
            });

            window.onValue(window.ref(window.voiceDb, `${callBase}/offer`), (snapshot) => {
                 if(!snapshot.exists()) window.endCall();
            });
        };

        window.rejectCall = function() {
            document.getElementById('ringtone').pause();
            window.remove(window.ref(window.voiceDb, `biotech_calls/${myIdentity}`));
            document.getElementById('incomingScreen').classList.add('hidden');
        };

        window.endCall = function() {
            if(disconnectTimer) clearTimeout(disconnectTimer);

            document.getElementById('ringtone').pause();
            document.getElementById('ringtone').currentTime = 0;

            if (peerConnection) peerConnection.close();
            if (localStream) localStream.getTracks().forEach(track => track.stop());
            if (currentCallRef) window.remove(currentCallRef);
            
            document.getElementById('activeScreen').classList.add('hidden');
            document.getElementById('incomingScreen').classList.add('hidden');
            document.getElementById('dialerScreen').classList.remove('hidden');
            
            isMuted = false;
            document.getElementById('muteBtn').classList.remove('bg-red-500');
            document.getElementById('muteBtn').classList.add('bg-slate-700');
            
            window.listenForCalls();
        };

        window.toggleMute = function() {
            if(localStream) {
                isMuted = !isMuted;
                localStream.getAudioTracks()[0].enabled = !isMuted;
                const btn = document.getElementById('muteBtn');
                if(isMuted) {
                    btn.classList.remove('bg-slate-700');
                    btn.classList.add('bg-red-500');
                } else {
                    btn.classList.remove('bg-red-500');
                    btn.classList.add('bg-slate-700');
                }
            }
        }

        function showActiveScreen(name, status) {
            document.getElementById('dialerScreen').classList.add('hidden');
            document.getElementById('activeScreen').classList.remove('hidden');
            document.getElementById('activeCallerName').innerText = name;
            document.getElementById('callStatus').innerText = status;
        }

        function handleConnectionState(state) {
            const statusEl = document.getElementById('callStatus');
            
            if (state === 'disconnected' || state === 'failed') {
                if(statusEl) {
                    statusEl.innerText = "Reconnecting...";
                    statusEl.classList.remove('text-green-500');
                    statusEl.classList.add('text-red-500');
                }
                if(disconnectTimer) clearTimeout(disconnectTimer);
                disconnectTimer = setTimeout(() => window.endCall(), 5000); 
                
            } else if (state === 'connected') {
                if(statusEl) {
                    statusEl.innerText = "Voice Connected";
                    statusEl.classList.remove('text-red-500');
                    statusEl.classList.add('text-green-500');
                    startTimer();
                }
                if(disconnectTimer) clearTimeout(disconnectTimer);
            }
        }

        function startTimer() {
            let seconds = 0;
            const timerEl = document.getElementById('callTimer');
            clearInterval(callTimerInterval);
            callTimerInterval = setInterval(() => {
                seconds++;
                const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
                const secs = (seconds % 60).toString().padStart(2, '0');
                timerEl.innerText = `${mins}:${secs}`;
            }, 1000);
        }

    </script>
</body>
</html>
