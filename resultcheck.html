<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Biotech | AI Report Assistant</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Noto+Sans+Sinhala:wght@400;700&family=Noto+Sans+Tamil:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #f1f5f9;
            height: 100dvh; 
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
            overflow: hidden;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        }

        /* Animations */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        
        @keyframes pulse-ring {
            0% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 15px rgba(255, 255, 255, 0); }
            100% { transform: scale(0.8); box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
        }

        @keyframes blob {
            0% { transform: translate(0px, 0px) scale(1); }
            33% { transform: translate(30px, -50px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
            100% { transform: translate(0px, 0px) scale(1); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .animate-float { animation: float 3s ease-in-out infinite; }
        .animate-pulse-slow { animation: pulse-ring 2s infinite; }
        .animate-blob { animation: blob 7s infinite alternate; }
        .animation-delay-2000 { animation-delay: 2s; }
        .animate-shake { animation: shake 0.2s ease-in-out 0s 2; }

        .glass-effect {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .chat-container {
            width: 100%;
            height: 100%;
            max-width: 480px;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 10;
        }

        @media (min-width: 640px) {
            .chat-container {
                height: 90vh;
                border-radius: 32px;
                overflow: hidden;
                box-shadow: 0 25px 50px -12px rgba(15, 118, 110, 0.25);
            }
        }

        .chat-body {
            flex-grow: 1;
            overflow-y: auto;
            padding: 24px;
            background-color: transparent;
            display: flex;
            flex-direction: column;
            gap: 18px;
            scroll-behavior: smooth;
        }

        /* Message Bubbles */
        .msg {
            max-width: 85%;
            padding: 14px 18px;
            border-radius: 20px;
            font-size: 14.5px;
            line-height: 1.6;
            animation: slideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
        }

        .msg-bot {
            background: white;
            color: #1e293b;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            box-shadow: 0 4px 15px -3px rgba(0,0,0,0.05);
        }

        .msg-user {
            background: linear-gradient(135deg, #0d9488 0%, #0f766e 100%);
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
            box-shadow: 0 10px 15px -3px rgba(13, 148, 136, 0.3);
        }

        /* Option Buttons */
        .option-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 15px;
        }

        .option-btn {
            background: #f8fafc;
            border: 1.5px solid #e2e8f0;
            padding: 14px;
            border-radius: 16px;
            text-align: center;
            font-weight: 700;
            color: #0f766e;
            transition: all 0.3s;
            cursor: pointer;
        }

        .option-btn:hover {
            border-color: #0d9488;
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(13, 148, 136, 0.1);
        }

        .typing-dots { display: flex; gap: 4px; padding: 4px 0; }
        .dot { width: 6px; height: 6px; background: #94a3b8; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both; }
        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }

        .custom-input {
            background: #f1f5f9;
            border: 2px solid transparent;
            border-radius: 16px;
            padding: 12px 16px;
            width: 100%;
            outline: none;
            transition: all 0.2s;
            font-weight: 600;
        }
        .custom-input:focus {
            background: white;
            border-color: #0d9488;
            box-shadow: 0 0 0 4px rgba(13, 148, 136, 0.1);
        }
        .input-error {
            border-color: #ef4444 !important;
            background: #fef2f2 !important;
        }
    </style>
</head>
<body class="relative">

    <!-- Animated Background Blobs -->
    <div class="absolute top-0 left-0 w-80 h-80 bg-teal-200 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob"></div>
    <div class="absolute bottom-0 right-0 w-80 h-80 bg-blue-200 rounded-full mix-blend-multiply filter blur-3xl opacity-30 animate-blob animation-delay-2000"></div>

    <div class="chat-container glass-effect">
        
        <!-- Premium Header -->
        <div class="bg-gradient-to-r from-teal-600 to-blue-600 p-6 text-center relative overflow-hidden">
            <div class="absolute inset-0 opacity-10" style="background-image: radial-gradient(#fff 1px, transparent 1px); background-size: 15px 15px;"></div>
            
            <div class="relative inline-block mb-3">
                <div class="absolute inset-0 bg-white rounded-full opacity-20 animate-pulse-slow"></div>
                <div class="relative bg-white text-teal-600 w-14 h-14 rounded-full flex items-center justify-center shadow-lg mx-auto animate-float">
                    <i class="fa-solid fa-microscope text-2xl"></i>
                </div>
            </div>
            
            <h1 class="text-white font-extrabold text-xl tracking-wide relative z-10">BIOTECH LABORATORY</h1>
            <p class="text-teal-100 text-[10px] font-medium tracking-widest relative z-10 uppercase">AI Clinical Assistant</p>
            
            <button onclick="resetLanguage()" class="absolute top-4 right-4 text-white/50 hover:text-white transition group" title="Change Language">
                <i class="fa-solid fa-globe group-hover:rotate-12 transition-transform"></i>
            </button>
        </div>

        <!-- Chat Area -->
        <div class="chat-body" id="chatBody">
            <!-- Messages injected here -->
        </div>

        <!-- Progress Footer -->
        <div class="p-5 bg-white/50 border-t border-teal-100/50 text-center">
            <div class="flex items-center justify-center gap-2 text-teal-600/60 font-bold text-[10px] tracking-widest uppercase">
                <i class="fa-solid fa-shield-halved"></i>
                End-to-End Encrypted Portal
            </div>
        </div>

        <!-- Language Modal -->
        <div id="langModal" class="modal-overlay absolute inset-0 bg-white/80 backdrop-blur-md z-50 flex items-center justify-center hidden">
            <div class="w-full max-w-[320px] p-8 text-center animate-float">
                <div class="w-20 h-20 bg-teal-600 text-white rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-2xl rotate-3">
                    <i class="fa-solid fa-language text-3xl"></i>
                </div>
                <h3 class="text-2xl font-black text-slate-800 mb-2">Welcome</h3>
                <p class="text-sm text-slate-500 mb-8">Select your preferred language to begin.</p>
                <div class="flex flex-col gap-3">
                    <button onclick="saveAndInit('en')" class="option-btn !bg-white">English</button>
                    <button onclick="saveAndInit('si')" class="option-btn !bg-white" style="font-family: 'Noto Sans Sinhala'">‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω</button>
                    <button onclick="saveAndInit('ta')" class="option-btn !bg-white" style="font-family: 'Noto Sans Tamil'">‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç</button>
                </div>
            </div>
        </div>

    </div>

    <script>
        const chatBody = document.getElementById('chatBody');
        const scriptURL = 'https://script.google.com/macros/s/AKfycbw24C_gOzLbDjR3Y7wbo8uH087cDIq2xTi13qGvm4e4m2bOEalZUufo7tq8SFQVXLm-/exec';
        
        let currentLang = 'en';
        let formData = { type: '', num: '', date: '', phone: '' };

        const i18n = {
            en: {
                welcome: "Hello! üëã I'm your Biotech Assistant. I'll help you access your laboratory reports instantly.",
                askType: "First, please select your <b>Sample Type</b> code:",
                askNum: "Great. Now, enter your <b>Sample Number</b>:",
                askDate: "When was this sample collected?",
                askPhone: "Finally, enter your registered <b>Phone Number</b>:",
                phoneError: "‚ö†Ô∏è That doesn't look like a valid number. Please ensure it has <b>exactly 10 digits</b> and <b>starts with 0</b> (e.g., 0712345678).",
                fetching: "Verifying credentials and fetching report...",
                ready: "Secure link generated! Redirecting...",
                btnDone: "Submit"
            },
            si: {
                welcome: "‡∂Ü‡∂∫‡∑î‡∂∂‡∑ù‡∑Ä‡∂±‡∑ä! üëã ‡∂∏‡∂∏ Biotech ‡∑É‡∑Ñ‡∑è‡∂∫‡∂ö‡∂∫‡∑è. ‡∂î‡∂∂‡∂ú‡∑ö ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è ‡∂Ω‡∂∂‡∑è ‡∂ú‡∑ê‡∂±‡∑ì‡∂∏‡∂ß ‡∂∏‡∂∏ ‡∂ã‡∂Ø‡∑Ä‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±‡∂∏‡∑ä.",
                askType: "‡∂¥‡∑Ö‡∂∏‡∑î‡∑Ä, ‡∂î‡∂∂‡∑ö <b>‡∑É‡∑è‡∂∏‡∑ä‡∂¥‡∂Ω ‡∑Ä‡∂ª‡∑ä‡∂ú‡∂∫</b> (Sample Type) ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±:",
                askNum: "‡∂Ø‡∑ê‡∂±‡∑ä, ‡∂î‡∂∂‡∑ö <b>‡∑É‡∑è‡∂∏‡∑ä‡∂¥‡∂Ω ‡∂Ö‡∂Ç‡∂ö‡∂∫</b> ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±:",
                askDate: "‡∑É‡∑è‡∂∏‡∑ä‡∂¥‡∂Ω‡∂∫ ‡∂Ω‡∂∂‡∑è‡∂ú‡∂≠‡∑ä <b>‡∂Ø‡∑í‡∂±‡∂∫</b> ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±:",
                askPhone: "‡∂Ö‡∑Ä‡∑É‡∑è‡∂± ‡∑Ä‡∑Å‡∂∫‡∑ô‡∂±‡∑ä, ‡∂î‡∂∂ ‡∂Ω‡∑í‡∂∫‡∑è‡∂¥‡∂Ø‡∑í‡∂Ç‡∂†‡∑í ‡∂ö‡∑Ö <b>‡∂Ø‡∑î‡∂ª‡∂ö‡∂Æ‡∂± ‡∂Ö‡∂Ç‡∂ö‡∂∫</b> ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±:",
                phoneError: "‚ö†Ô∏è ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∑Ö ‡∂Ö‡∂Ç‡∂ö‡∂∫ ‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í‡∂∫‡∑í. ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂ë‡∂∫ <b>‡∂∂‡∑í‡∂±‡∑ä‡∂Ø‡∑î‡∑Ä‡∑ô‡∂±‡∑ä (0) ‡∂Ü‡∂ª‡∂∏‡∑ä‡∂∑ ‡∑Ä‡∂±</b> ‡∂â‡∂Ω‡∂ö‡∑ä‡∂ö‡∂∏‡∑ä 10 ‡∂ö ‡∂Ö‡∂Ç‡∂ö‡∂∫‡∂ö‡∑ä ‡∂∂‡∑Ä ‡∂≠‡∑Ñ‡∑Ä‡∑î‡∂ª‡∑î ‡∂ö‡∂ª‡∂ú‡∂±‡∑ä‡∂±.",
                fetching: "‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è ‡∂ö‡∂ª‡∂∏‡∑í‡∂±‡∑ä ‡∂¥‡∑Ä‡∂≠‡∑ì...",
                ready: "‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä ‡∑É‡∑ñ‡∂Ø‡∑è‡∂±‡∂∏‡∑ä! ‡∑Ä‡∑í‡∑Ä‡∑ò‡∂≠ ‡∑Ä‡∑ô‡∂∏‡∑í‡∂±‡∑ä ‡∂¥‡∑Ä‡∂≠‡∑ì...",
                btnDone: "‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±"
            },
            ta: {
                welcome: "‡Æµ‡Æ£‡Æï‡Øç‡Æï‡ÆÆ‡Øç! üëã ‡Æ®‡Ææ‡Æ©‡Øç ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç Biotech ‡Æâ‡Æ§‡Æµ‡Æø‡ÆØ‡Ææ‡Æ≥‡Æ∞‡Øç. ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡ÆÖ‡Æ±‡Æø‡Æï‡Øç‡Æï‡Øà‡Æï‡Æ≥‡Øà‡Æ™‡Øç ‡Æ™‡ØÜ‡Æ± ‡Æ®‡Ææ‡Æ©‡Øç ‡Æâ‡Æ§‡Æµ‡ØÅ‡Æï‡Æø‡Æ±‡Øá‡Æ©‡Øç.",
                askType: "‡ÆÆ‡ØÅ‡Æ§‡Æ≤‡Æø‡Æ≤‡Øç, ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç <b>‡ÆÆ‡Ææ‡Æ§‡Æø‡Æ∞‡Æø ‡Æµ‡Æï‡Øà</b>‡ÆØ‡Øà‡Æ§‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æ®‡Øç‡Æ§‡ØÜ‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç:",
                askNum: "‡Æá‡Æ™‡Øç‡Æ™‡Øã‡Æ§‡ØÅ, ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç <b>‡ÆÆ‡Ææ‡Æ§‡Æø‡Æ∞‡Æø ‡Æé‡Æ£‡Øç</b>‡Æ£‡Øà ‡Æâ‡Æ≥‡Øç‡Æ≥‡Æø‡Æü‡Æµ‡ØÅ‡ÆÆ‡Øç:",
                askDate: "‡ÆÆ‡Ææ‡Æ§‡Æø‡Æ∞‡Æø ‡Æé‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü <b>‡Æ§‡Øá‡Æ§‡Æø</b>‡ÆØ‡Øà‡Æ§‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æ®‡Øç‡Æ§‡ØÜ‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç:",
                askPhone: "‡Æá‡Æ±‡ØÅ‡Æ§‡Æø‡ÆØ‡Ææ‡Æï, ‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç <b>‡Æ§‡Øä‡Æ≤‡Øà‡Æ™‡Øá‡Æö‡Æø ‡Æé‡Æ£‡Øç</b>‡Æ£‡Øà ‡Æâ‡Æ≥‡Øç‡Æ≥‡Æø‡Æü‡Æµ‡ØÅ‡ÆÆ‡Øç:",
                phoneError: "‚ö†Ô∏è ‡Æâ‡Æ≥‡Øç‡Æ≥‡Æø‡Æü‡Øç‡Æü ‡Æé‡Æ£‡Øç ‡Æ§‡Æµ‡Æ±‡Ææ‡Æ©‡Æ§‡ØÅ. ‡ÆÖ‡Æ§‡ØÅ <b>0 ‡Æá‡Æ≤‡Øç ‡ÆÜ‡Æ∞‡ÆÆ‡Øç‡Æ™‡Æø‡Æ§‡Øç‡Æ§‡ØÅ</b> ‡Æö‡Æ∞‡Æø‡ÆØ‡Ææ‡Æï 10 ‡Æá‡Æ≤‡Æï‡Øç‡Æï‡Æô‡Øç‡Æï‡Æ≥‡Øà‡Æï‡Øç ‡Æï‡Øä‡Æ£‡Øç‡Æü‡Æø‡Æ∞‡ØÅ‡Æ™‡Øç‡Æ™‡Æ§‡Øà ‡Æâ‡Æ±‡ØÅ‡Æ§‡Æø‡Æ™‡Øç‡Æ™‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡Æµ‡ØÅ‡ÆÆ‡Øç.",
                fetching: "‡Æ§‡Æ∞‡Æµ‡ØÅ‡Æï‡Æ≥‡Øà‡Æ§‡Øç ‡Æ§‡Øá‡Æü‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ...",
                ready: "‡ÆÖ‡Æ±‡Æø‡Æï‡Øç‡Æï‡Øà ‡Æ§‡ÆØ‡Ææ‡Æ∞‡Øç! ‡Æ§‡Æø‡Æ±‡Æï‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡ØÅ‡Æï‡Æø‡Æ±‡Æ§‡ØÅ...",
                btnDone: "‡Æö‡ÆÆ‡Æ∞‡Øç‡Æ™‡Øç‡Æ™‡Æø‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç"
            }
        };

        window.onload = function() {
            const savedLang = localStorage.getItem('biotech_assistant_lang');
            if (savedLang && i18n[savedLang]) {
                initApp(savedLang);
            } else {
                document.getElementById('langModal').classList.remove('hidden');
            }
        };

        function saveAndInit(lang) {
            localStorage.setItem('biotech_assistant_lang', lang);
            initApp(lang);
        }

        function resetLanguage() {
            localStorage.removeItem('biotech_assistant_lang');
            location.reload();
        }

        function initApp(lang) {
            currentLang = lang;
            document.getElementById('langModal').classList.add('hidden');
            addMessage(i18n[currentLang].welcome, 'bot');
            setTimeout(() => step1_Type(), 800);
        }

        function step1_Type() {
            const html = `
                <div>
                    ${i18n[currentLang].askType}
                    <div class="option-grid">
                        <div class="option-btn" onclick="selectType('VG')">VG</div>
                        <div class="option-btn" onclick="selectType('BN')">BN</div>
                        <div class="option-btn" onclick="selectType('NI')">NI</div>
                        <div class="option-btn" onclick="selectType('BR')">BR</div>
                    </div>
                </div>
            `;
            addMessage(html, 'bot');
        }

        function selectType(val) {
            formData.type = val;
            addMessage(val, 'user');
            setTimeout(() => step2_Num(), 600);
        }

        function step2_Num() {
            const id = 'num_' + Date.now();
            const html = `
                <div>
                    ${i18n[currentLang].askNum}
                    <div class="mt-4 flex gap-2">
                        <input type="number" id="${id}" class="custom-input" placeholder="0000" autofocus>
                        <button onclick="submitNum('${id}')" class="bg-teal-600 text-white w-14 rounded-2xl shadow-lg shadow-teal-200"><i class="fa-solid fa-arrow-right"></i></button>
                    </div>
                </div>
            `;
            addMessage(html, 'bot');
            document.getElementById(id).focus();
        }

        function submitNum(id) {
            const input = document.getElementById(id);
            if(!input.value) return;
            formData.num = input.value;
            input.disabled = true;
            addMessage(input.value, 'user');
            setTimeout(() => step3_Date(), 600);
        }

        function step3_Date() {
            const id = 'date_' + Date.now();
            const today = new Date().toISOString().split('T')[0];
            const html = `
                <div>
                    ${i18n[currentLang].askDate}
                    <div class="mt-4 flex gap-2">
                        <input type="date" id="${id}" value="${today}" class="custom-input">
                        <button onclick="submitDate('${id}')" class="bg-teal-600 text-white w-14 rounded-2xl shadow-lg shadow-teal-200"><i class="fa-solid fa-arrow-right"></i></button>
                    </div>
                </div>
            `;
            addMessage(html, 'bot');
        }

        function submitDate(id) {
            const input = document.getElementById(id);
            formData.date = input.value;
            input.disabled = true;
            addMessage(input.value, 'user');
            setTimeout(() => step4_Phone(), 600);
        }

        function step4_Phone() {
            const id = 'phone_' + Date.now();
            const html = `
                <div>
                    ${i18n[currentLang].askPhone}
                    <div class="mt-4 flex gap-2">
                        <input type="tel" id="${id}" class="custom-input" placeholder="07XXXXXXXX" maxlength="10">
                        <button onclick="submitFinal('${id}')" class="bg-teal-700 text-white px-6 rounded-2xl font-bold uppercase text-xs tracking-widest">${i18n[currentLang].btnDone}</button>
                    </div>
                </div>
            `;
            addMessage(html, 'bot');
            document.getElementById(id).focus();
        }

        function submitFinal(id) {
            const input = document.getElementById(id);
            const phone = input.value.trim();
            
            // Validation
            const isValid = /^0\d{9}$/.test(phone);
            
            if (!isValid) {
                input.classList.add('animate-shake', 'input-error');
                setTimeout(() => input.classList.remove('animate-shake'), 400);
                addMessage(i18n[currentLang].phoneError, 'bot');
                return;
            }

            input.classList.remove('input-error');
            formData.phone = phone;
            input.disabled = true;
            addMessage(phone, 'user');
            
            showLoadingFlow();
        }

        async function showLoadingFlow() {
            const loadingMsg = addMessage(`<div class="typing-dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>`, 'bot');
            
            // Prepare data for Google Sheet
            const params = new URLSearchParams({
                type: formData.type,
                sampleNumber: formData.num,
                date: formData.date,
                phone: formData.phone,
                language: currentLang,
                timestamp: new Date().toLocaleString()
            });

            // Fire and forget data to Google Sheet
            // We use no-cors because Apps Script might not return CORS headers for simple web apps
            fetch(`${scriptURL}?${params.toString()}`, {
                method: 'GET',
                mode: 'no-cors'
            }).catch(err => console.log("Logging suppressed or failed", err));

            setTimeout(() => {
                loadingMsg.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin mr-2 text-teal-600"></i> ${i18n[currentLang].fetching}`;
                
                setTimeout(() => {
                    loadingMsg.innerHTML = `<i class="fa-solid fa-circle-check text-green-500 mr-2"></i> ${i18n[currentLang].ready}`;
                    
                    const patientId = formData.type + formData.num;
                    const expiry = new Date().getTime() + (14 * 24 * 60 * 60 * 1000);
                    const encoded = btoa(`${patientId}|${formData.date}|${expiry}`);
                    const finalUrl = `https://biotechveyangoda.lk/report-preview.html?data=${encoded}`;

                    setTimeout(() => {
                        window.location.href = finalUrl;
                    }, 1200);

                }, 2000);
            }, 1200);
        }

        function addMessage(content, sender) {
            const div = document.createElement('div');
            div.className = `msg msg-${sender}`;
            div.innerHTML = content;
            chatBody.appendChild(div);
            chatBody.scrollTop = chatBody.scrollHeight;
            return div;
        }
    </script>
</body>
</html>
