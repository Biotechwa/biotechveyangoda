<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Biotech | AI Assistant</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Sinhala:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Tamil:wght@400;700&display=swap');
        
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #e2e8f0;
            height: 100dvh; 
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
            overflow: hidden;
        }

        .chat-container {
            width: 100%;
            height: 100%;
            max-width: 450px;
            background: #ffffff;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            position: relative;
        }

        @media (min-width: 640px) {
            .chat-container {
                height: 90vh;
                border-radius: 24px;
                overflow: hidden;
            }
        }

        .chat-body {
            flex-grow: 1;
            overflow-y: auto;
            padding: 16px;
            padding-bottom: 80px; /* Space for input area */
            background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
            background-blend-mode: soft-light;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            gap: 12px;
            -webkit-overflow-scrolling: touch;
        }

        /* Message Bubbles */
        .msg {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.5;
            position: relative;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease-out;
        }

        .msg-bot {
            background-color: #ffffff;
            color: #334155;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
        }

        .msg-user {
            background-color: #d9fdd3;
            color: #111b21;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
        }

        /* Form Bubble Styling */
        .msg-form {
            width: 100%;
            min-width: 250px;
        }

        /* Suggestion Chips */
        .chips-container {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding-bottom: 5px;
            margin-top: 8px;
            scrollbar-width: none;
        }
        .chips-container::-webkit-scrollbar { display: none; }

        .chip {
            white-space: nowrap;
            background: rgba(15, 118, 110, 0.08);
            color: #0f766e;
            border: 1px solid rgba(15, 118, 110, 0.2);
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
        }
        .chip:hover, .chip:active {
            background: #0f766e;
            color: white;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* POPUP MODAL STYLES (For Language Only) */
        .modal-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease-out;
        }
        
        .modal-card {
            background: white;
            width: 90%;
            max-width: 340px;
            text-align: center;
        }

        .lang-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            font-weight: bold;
            color: #334155;
            background: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
        }
        .lang-btn:hover, .lang-btn:active {
            border-color: #0d9488;
            background: #f0fdfa;
            color: #0f766e;
            transform: scale(1.02);
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="chat-container">
        
        <!-- Chat Header -->
        <div class="bg-[#0f766e] text-white px-4 py-3 flex items-center gap-4 shadow-md z-10 shrink-0">
            <div class="w-10 h-10 rounded-full border-2 border-white/30 overflow-hidden bg-white shrink-0">
                <img src="img/carousel-1.jpg" alt="Biotech Logo" class="w-full h-full object-cover" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3774/3774299.png'">
            </div>
            <div class="flex-grow">
                <h1 class="font-bold text-lg leading-tight">Biotech Laboratory</h1>
                <div class="flex items-center gap-1.5">
                    <span class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></span>
                    <p class="text-xs text-teal-100">Online | 077 352 4143</p>
                </div>
            </div>
            <a href="https://wa.me/94773524143" target="_blank" class="w-9 h-9 flex items-center justify-center bg-white/20 rounded-full text-white hover:bg-white/30 transition">
                <i class="fa-brands fa-whatsapp text-lg"></i>
            </a>
        </div>

        <!-- Chat Body -->
        <div class="chat-body custom-scroll" id="chatBody">
            <!-- Messages will appear here -->
        </div>

        <!-- Chat Input Area -->
        <div class="bg-[#f0f2f5] px-3 py-3 flex items-end gap-2 border-t border-slate-200 z-10 shrink-0 safe-area-bottom absolute bottom-0 w-full">
            <div class="flex-grow bg-white rounded-3xl border border-slate-300 overflow-hidden shadow-sm flex items-center px-4 py-3">
                <input type="text" id="textInput" placeholder="Type message..." class="w-full bg-transparent outline-none text-[16px] text-slate-700 placeholder:text-slate-400" onkeypress="handleKeyPress(event)" autocomplete="off">
            </div>
            <button onclick="sendText()" class="w-12 h-12 rounded-full bg-[#0f766e] hover:bg-[#0d9488] active:scale-95 text-white flex items-center justify-center transition shadow-md flex-shrink-0">
                <i class="fa-solid fa-paper-plane text-lg"></i>
            </button>
        </div>

        <!-- LANGUAGE MODAL (First Load Only) -->
        <div id="langModal" class="modal-overlay">
            <div class="modal-card">
                <div class="w-16 h-16 bg-teal-50 text-teal-600 rounded-full flex items-center justify-center mx-auto mb-6 shadow-sm border border-teal-100">
                    <i class="fa-solid fa-earth-americas text-3xl"></i>
                </div>
                <h3 class="text-xl font-extrabold text-slate-800 mb-2">Select Language</h3>
                <p class="text-sm text-slate-400 mb-8 font-medium">Please choose your preferred language</p>
                
                <button onclick="selectLanguage('en')" class="lang-btn">
                    English
                </button>
                <button onclick="selectLanguage('si')" class="lang-btn" style="font-family: 'Noto Sans Sinhala', sans-serif;">
                    ‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω (Sinhala)
                </button>
                <button onclick="selectLanguage('ta')" class="lang-btn" style="font-family: 'Noto Sans Tamil', sans-serif;">
                    ‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç (Tamil)
                </button>
            </div>
        </div>

    </div>

    <script>
        const chatBody = document.getElementById('chatBody');
        const textInput = document.getElementById('textInput');
        const langModal = document.getElementById('langModal');
        
        let currentLang = 'en';

        // Translations
        const i18n = {
            en: {
                welcome: "Hello! üëã<br>Welcome to Biotech Laboratory.<br><br>I can help you check your reports instantly.",
                formTitle: "Get Your Report",
                formSubtitle: "Please select Type & Enter Number",
                labelType: "TYPE",
                labelNum: "NUMBER",
                btnNext: "Next",
                dateTitle: "Select Date",
                dateSubtitle: "When was",
                dateIssued: "issued?",
                btnOpen: "Open Report",
                errorNum: "Please enter a number!",
                errorDate: "Please select a date!",
                successMsg: "Opening Report for",
                chips: ["üìç Location", "üìû Contact"]
            },
            si: {
                welcome: "‡∂Ü‡∂∫‡∑î‡∂∂‡∑ù‡∑Ä‡∂±‡∑ä! üëã<br>Biotech ‡∂ª‡∑É‡∑è‡∂∫‡∂±‡∑è‡∂ú‡∑è‡∂ª‡∂∫ ‡∑Ä‡∑ô‡∂≠ ‡∑É‡∑è‡∂Ø‡∂ª‡∂∫‡∑ô‡∂±‡∑ä ‡∂¥‡∑í‡∑Ö‡∑í‡∂ú‡∂±‡∑í‡∂∏‡∑î.<br><br>‡∂î‡∂∂‡∂ú‡∑ö ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è ‡∂¥‡∂ª‡∑ì‡∂ö‡∑ä‡∑Ç‡∑è ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß ‡∂∏‡∂ß ‡∂ã‡∂Ø‡∑Ä‡∑ä ‡∂ö‡∑Ö ‡∑Ñ‡∑ê‡∂ö.",
                formTitle: "‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä ‡∂Ω‡∂∂‡∑è‡∂ú‡∂±‡∑ä‡∂±",
                formSubtitle: "‡∑Ä‡∂ª‡∑ä‡∂ú‡∂∫ ‡∑É‡∑Ñ ‡∂Ö‡∂Ç‡∂ö‡∂∫ ‡∂á‡∂≠‡∑î‡∂Ω‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±",
                labelType: "‡∑Ä‡∂ª‡∑ä‡∂ú‡∂∫",
                labelNum: "‡∂Ö‡∂Ç‡∂ö‡∂∫",
                btnNext: "‡∂â‡∂Ø‡∑í‡∂ª‡∑í‡∂∫‡∂ß",
                dateTitle: "‡∂Ø‡∑í‡∂±‡∂∫ ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±",
                dateSubtitle: "‡∂±‡∑í‡∂ö‡∑î‡∂≠‡∑ä ‡∂ö‡∑Ö ‡∂Ø‡∑í‡∂±‡∂∫",
                dateIssued: "‡∂ö‡∑Ä‡∂Ø‡∑è‡∂Ø?",
                btnOpen: "‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä ‡∂∂‡∂Ω‡∂±‡∑ä‡∂±",
                errorNum: "‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂Ö‡∂Ç‡∂ö‡∂∫‡∂ö‡∑ä ‡∂á‡∂≠‡∑î‡∂Ω‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±!",
                errorDate: "‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂Ø‡∑í‡∂±‡∂∫‡∂ö‡∑ä ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±!",
                successMsg: "‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä ‡∑Ä‡∑í‡∑Ä‡∑ò‡∂≠ ‡∑Ä‡∑ö",
                chips: ["üìç ‡∂¥‡∑í‡∑Ñ‡∑í‡∂ß‡∑ì‡∂∏", "üìû ‡∂á‡∂∏‡∂≠‡∑î‡∂∏‡∑ä"]
            },
            ta: {
                welcome: "‡Æµ‡Æ£‡Æï‡Øç‡Æï‡ÆÆ‡Øç! üëã<br>Biotech ‡ÆÜ‡ÆØ‡Øç‡Æµ‡Æï‡Æ§‡Øç‡Æ§‡Æø‡Æ±‡Øç‡Æï‡ØÅ ‡Æµ‡Æ∞‡Æµ‡Øá‡Æ±‡Øç‡Æï‡Æø‡Æ±‡Øã‡ÆÆ‡Øç.<br><br>‡Æâ‡Æô‡Øç‡Æï‡Æ≥‡Øç ‡ÆÖ‡Æ±‡Æø‡Æï‡Øç‡Æï‡Øà‡Æï‡Æ≥‡Øà ‡Æö‡Æ∞‡Æø‡Æ™‡Ææ‡Æ∞‡Øç‡Æï‡Øç‡Æï ‡Æ®‡Ææ‡Æ©‡Øç ‡Æâ‡Æ§‡Æµ ‡ÆÆ‡ØÅ‡Æü‡Æø‡ÆØ‡ØÅ‡ÆÆ‡Øç.",
                formTitle: "‡ÆÖ‡Æ±‡Æø‡Æï‡Øç‡Æï‡Øà‡ÆØ‡Øà‡Æ™‡Øç ‡Æ™‡ØÜ‡Æ±‡ØÅ‡Æô‡Øç‡Æï‡Æ≥‡Øç",
                formSubtitle: "‡Æµ‡Æï‡Øà ‡ÆÆ‡Æ±‡Øç‡Æ±‡ØÅ‡ÆÆ‡Øç ‡Æé‡Æ£‡Øç‡Æ£‡Øà ‡Æâ‡Æ≥‡Øç‡Æ≥‡Æø‡Æü‡Æµ‡ØÅ‡ÆÆ‡Øç",
                labelType: "‡Æµ‡Æï‡Øà",
                labelNum: "‡Æé‡Æ£‡Øç",
                btnNext: "‡ÆÖ‡Æü‡ØÅ‡Æ§‡Øç‡Æ§‡ØÅ",
                dateTitle: "‡Æ§‡Øá‡Æ§‡Æø‡ÆØ‡Øà‡Æ§‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æ®‡Øç‡Æ§‡ØÜ‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç",
                dateSubtitle: "‡Æµ‡Æ¥‡Æô‡Øç‡Æï‡Æ™‡Øç‡Æ™‡Æü‡Øç‡Æü ‡Æ§‡Øá‡Æ§‡Æø",
                dateIssued: "‡Æé‡Æ™‡Øç‡Æ™‡Øã‡Æ§‡ØÅ?",
                btnOpen: "‡ÆÖ‡Æ±‡Æø‡Æï‡Øç‡Æï‡Øà‡ÆØ‡Øà‡Æ™‡Øç ‡Æ™‡Ææ‡Æ∞‡Øç",
                errorNum: "‡Æ§‡ÆØ‡Æµ‡ØÅ‡Æö‡ØÜ‡ÆØ‡Øç‡Æ§‡ØÅ ‡Æé‡Æ£‡Øç‡Æ£‡Øà ‡Æâ‡Æ≥‡Øç‡Æ≥‡Æø‡Æü‡Æµ‡ØÅ‡ÆÆ‡Øç!",
                errorDate: "‡Æ§‡Øá‡Æ§‡Æø‡ÆØ‡Øà‡Æ§‡Øç ‡Æ§‡Øá‡Æ∞‡Øç‡Æ®‡Øç‡Æ§‡ØÜ‡Æü‡ØÅ‡Æï‡Øç‡Æï‡Æµ‡ØÅ‡ÆÆ‡Øç!",
                successMsg: "‡ÆÖ‡Æ±‡Æø‡Æï‡Øç‡Æï‡Øà ‡Æ§‡Æø‡Æ±‡Æï‡Øç‡Æï‡Æø‡Æ±‡Æ§‡ØÅ",
                chips: ["üìç ‡Æá‡Æü‡ÆÆ‡Øç", "üìû ‡Æ§‡Øä‡Æü‡Æ∞‡Øç‡Æ™‡ØÅ"]
            }
        };

        // --- LANGUAGE & START FLOW ---

        function selectLanguage(lang) {
            currentLang = lang;
            langModal.classList.add('hidden');
            
            // Start the conversation
            startChat();
        }

        function startChat() {
            const t = i18n[currentLang];
            
            // 1. Welcome Message
            const chipsHtml = t.chips.map(c => `<button class="chip" onclick="sendText('${c}')">${c}</button>`).join('');
            
            const welcomeMsg = `
                ${t.welcome}
                <div class="chips-container">
                    <button class="chip" onclick="sendFormBubble()">üìÑ Check Report</button>
                    ${chipsHtml}
                </div>
            `;
            appendMessage(welcomeMsg, 'bot');

            // 2. Automatically send the Form Bubble
            setTimeout(() => {
                sendFormBubble();
            }, 800);
        }

        // --- BUBBLE GENERATORS ---

        function sendFormBubble() {
            const t = i18n[currentLang];
            
            // Only send if last message wasn't the form (prevent duplicates)
            const lastMsg = chatBody.lastElementChild;
            if(lastMsg && lastMsg.querySelector('.msg-form')) return;

            const formHtml = `
                <div class="msg-form">
                    <div class="font-bold text-slate-800 text-[15px] mb-1">${t.formTitle}</div>
                    <div class="text-xs text-slate-500 mb-3">${t.formSubtitle}</div>
                    
                    <div class="flex gap-2 mb-3">
                        <div class="w-1/3">
                            <label class="block text-[9px] text-slate-400 font-bold mb-1">${t.labelType}</label>
                            <select id="chatPrefix" class="w-full bg-slate-50 border border-slate-300 rounded-lg px-1 py-2 text-sm font-bold text-slate-700 outline-none focus:border-teal-500">
                                <option value="VG">VG</option>
                                <option value="BN">BN</option>
                                <option value="NI">NI</option>
                                <option value="BR">BR</option>
                            </select>
                        </div>
                        <div class="w-2/3">
                            <label class="block text-[9px] text-slate-400 font-bold mb-1">${t.labelNum}</label>
                            <input type="number" id="chatNum" class="w-full bg-slate-50 border border-slate-300 rounded-lg px-3 py-2 text-sm font-bold text-slate-700 outline-none focus:border-teal-500" placeholder="12">
                        </div>
                    </div>
                    
                    <button onclick="submitFormBubble(this)" class="w-full bg-teal-600 text-white font-bold py-2 rounded-lg text-sm hover:bg-teal-700 active:scale-95 transition">
                        ${t.btnNext}
                    </button>
                </div>
            `;
            appendMessage(formHtml, 'bot');
        }

        function submitFormBubble(btn) {
            const container = btn.closest('.msg-form');
            const prefix = container.querySelector('#chatPrefix').value;
            const numInput = container.querySelector('#chatNum');
            const num = numInput.value.trim();
            const t = i18n[currentLang];

            if(!num) {
                numInput.classList.add('border-red-400');
                setTimeout(() => numInput.classList.remove('border-red-400'), 500);
                return;
            }

            // Lock inputs
            container.querySelector('#chatPrefix').disabled = true;
            numInput.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-check"></i>';
            btn.disabled = true;
            btn.classList.add('opacity-50');

            // Trigger Date Bubble
            setTimeout(() => {
                sendDateBubble(prefix, num);
            }, 500);
        }

        function sendDateBubble(prefix, num) {
            const t = i18n[currentLang];
            const today = new Date().toISOString().split('T')[0];
            
            const dateHtml = `
                <div class="msg-form">
                    <div class="font-bold text-slate-800 text-[15px] mb-1">${t.dateTitle}</div>
                    <div class="text-xs text-slate-500 mb-3">${t.dateSubtitle} <strong class="text-teal-700">${prefix}${num}</strong> ${t.dateIssued}</div>
                    
                    <input type="date" id="chatDate" class="w-full bg-slate-50 border border-slate-300 rounded-lg px-3 py-2 text-sm font-bold text-slate-700 text-center outline-none focus:border-teal-500 mb-3" value="${today}">
                    
                    <button onclick="submitDateBubble(this, '${prefix}', '${num}')" class="w-full bg-teal-600 text-white font-bold py-2 rounded-lg text-sm hover:bg-teal-700 active:scale-95 transition">
                        ${t.btnOpen}
                    </button>
                </div>
            `;
            appendMessage(dateHtml, 'bot');
        }

        function submitDateBubble(btn, prefix, num) {
            const container = btn.closest('.msg-form');
            const dateInput = container.querySelector('#chatDate');
            const dateStr = dateInput.value;
            const t = i18n[currentLang];

            if(!dateStr) {
                alert(t.errorDate);
                return;
            }

            // Lock inputs
            dateInput.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            
            const link = generateSecureLink(prefix, num, dateStr);
            
            setTimeout(() => {
                btn.innerHTML = t.btnOpen;
                // Open link
                window.open(link, '_blank');
                
                // Show link button in chat history
                const successHtml = `
                    ‚úÖ <strong>${t.successMsg}</strong><br>
                    ID: ${prefix}${num}<br>
                    <a href="${link}" target="_blank" class="block bg-teal-50 text-teal-700 font-bold py-2 px-3 rounded-lg text-center border border-teal-200 hover:bg-teal-100 mt-2 text-xs">
                        View PDF
                    </a>
                `;
                appendMessage(successHtml, 'bot');
            }, 600);
        }

        // --- HELPER FUNCTIONS ---

        function appendMessage(content, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `msg ${sender === 'bot' ? 'msg-bot' : 'msg-user'}`;
            msgDiv.innerHTML = content;
            chatBody.appendChild(msgDiv);
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter') sendText();
        }

        function sendText(val) {
            const text = val || textInput.value.trim();
            if (!text) return;

            appendMessage(text, 'user');
            textInput.value = '';

            // Simple Keyword Reply (Offline)
            setTimeout(() => {
                const lower = text.toLowerCase();
                if(lower.includes('contact') || lower.includes('phone')) {
                    appendMessage("üìû 077 352 4143", 'bot');
                } else if(lower.includes('location') || lower.includes('where')) {
                    appendMessage("üìç No 117A, Negombo Road, Veyangoda", 'bot');
                } else {
                    sendFormBubble(); // Default to report check
                }
            }, 500);
        }

        function generateSecureLink(prefix, num, dateStr) {
            const patientId = `${prefix}${num}`;
            const dateObj = new Date();
            const expiryTimestamp = dateObj.getTime() + (14 * 24 * 60 * 60 * 1000); 
            const originalData = `${patientId}|${dateStr}|${expiryTimestamp}`;
            return `https://biotechveyangoda.lk/report-preview.html?data=${btoa(originalData)}`;
        }

    </script>
</body>
</html>
