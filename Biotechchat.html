<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Biotech Chat | Mobile</title>
    
    <!-- TAILWIND CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ICONS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; 
            background-image: radial-gradient(#1f2937 1px, transparent 1px);
            background-size: 20px 20px;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #app-frame {
            width: 100%;
            height: 100%;
            background: #fff;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        @media (min-width: 768px) {
            #app-frame {
                max-width: 420px;
                height: 90vh;
                border-radius: 24px;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
                border: 8px solid #1f2937;
            }
        }

        .chat-scroll::-webkit-scrollbar { width: 4px; }
        .chat-scroll::-webkit-scrollbar-track { background: transparent; }
        .chat-scroll::-webkit-scrollbar-thumb { background: rgba(20, 184, 166, 0.3); border-radius: 10px; }

        .animate-enter { animation: fadeInUp 0.4s ease-out forwards; opacity: 0; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .msg-sent { 
            align-self: flex-end; 
            background: linear-gradient(135deg, #0d9488 0%, #0f766e 100%); 
            color: white;
            border-bottom-right-radius: 2px; 
            box-shadow: 0 2px 4px rgba(13, 148, 136, 0.2);
        }
        .msg-received { 
            align-self: flex-start; 
            background-color: #f3f4f6; 
            color: #1f2937;
            border-bottom-left-radius: 2px; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .status-dot {
            height: 8px; width: 8px; background-color: #4ade80; border-radius: 50%; display: inline-block;
            box-shadow: 0 0 0 2px rgba(74, 222, 128, 0.3);
            animation: pulse 2s infinite;
        }
        
        .recording-pulse { animation: recordPulse 1s infinite; color: #ef4444 !important; }
        @keyframes recordPulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        
        .ringing-animation { animation: ring 1s infinite ease-in-out; }
        @keyframes ring { 0% { transform: rotate(0); } 10% { transform: rotate(10deg); } 20% { transform: rotate(-10deg); } 30% { transform: rotate(10deg); } 40% { transform: rotate(-10deg); } 100% { transform: rotate(0); } }

        audio { height: 32px; max-width: 180px; }
        .msg-sent audio { filter: invert(1) opacity(0.9); }

        .emoji-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 5px; max-height: 150px; overflow-y: auto; }
        .emoji-btn { font-size: 1.2rem; padding: 6px; border-radius: 4px; cursor: pointer; text-align: center; }
        .emoji-btn:hover { background-color: #f0fdf4; }
    </style>
</head>
<body>

    <!-- HIDDEN AUDIO ELEMENT FOR CALLS -->
    <audio id="remoteAudio" autoplay playsinline></audio>

    <!-- APP CONTAINER -->
    <main id="app-frame">
        
        <!-- HEADER -->
        <header class="bg-teal-900 text-white p-4 shadow-md z-20 flex justify-between items-center shrink-0">
            <div class="flex flex-col">
                <h1 class="font-bold text-lg tracking-wide flex items-center gap-2">
                    <i class="fa-solid fa-comments text-teal-400"></i> BIOTECH
                </h1>
                <div class="text-[10px] text-teal-200 flex items-center gap-1">
                    <span class="status-dot"></span> Online System
                </div>
            </div>
            
            <div class="flex items-center gap-3">
                <button onclick="toggleCallModal()" class="w-9 h-9 rounded-full bg-white/10 flex items-center justify-center hover:bg-white/20 transition backdrop-blur-sm relative">
                    <i class="fa-solid fa-phone text-sm"></i>
                </button>
                <button onclick="clearChat()" class="w-9 h-9 rounded-full bg-white/10 flex items-center justify-center hover:bg-red-500/20 hover:text-red-300 transition backdrop-blur-sm">
                    <i class="fa-solid fa-trash-can text-sm"></i>
                </button>
            </div>
        </header>
        
        <!-- IDENTITY BAR -->
        <div class="bg-gray-50 border-b border-gray-200 p-2 shrink-0 z-10">
            <div class="relative">
                <select id="branchIdentity" onchange="updateIdentity()" class="w-full bg-white text-xs font-bold text-gray-700 py-2 pl-8 pr-4 rounded-lg border border-gray-200 focus:border-teal-500 outline-none appearance-none shadow-sm">
                    <option value="HEAD OFFICE">üè¢ HEAD OFFICE</option>
                    <option value="VEYANGODA">üß™ VEYANGODA (VG)</option>
                    <option value="Naiwala">üß™ NAIWALA (NI)</option>
                    <option value="BANDARANAYAKE">üß™ BANDARANAYAKE (BN)</option>
                    <option value="BANDURAGODA">üß™ BANDURAGODA (BR)</option>
                </select>
                <i class="fa-solid fa-user-circle absolute left-2.5 top-2.5 text-gray-400 text-xs"></i>
                <i class="fa-solid fa-chevron-down absolute right-3 top-3 text-gray-400 text-[10px]"></i>
            </div>
        </div>

        <!-- MESSAGES AREA -->
        <div id="chatContainer" class="flex-1 overflow-y-auto p-4 flex flex-col gap-3 bg-slate-50 chat-scroll relative">
            <div class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 opacity-60 pointer-events-none">
                <i class="fa-solid fa-circle-notch fa-spin text-2xl mb-2"></i>
                <span class="text-xs">Syncing...</span>
            </div>
        </div>

        <!-- FLOATING OVERLAYS -->
        
        <!-- 1. CALL DIRECTORY MODAL -->
        <div id="callModal" class="hidden absolute inset-0 bg-gray-900/95 z-50 flex flex-col animate-enter">
            <div class="p-4 bg-gray-800 text-white flex justify-between items-center border-b border-gray-700 shrink-0">
                <h3 class="font-bold"><i class="fa-solid fa-address-book text-teal-400 mr-2"></i> Directory</h3>
                <button onclick="toggleCallModal()" class="w-8 h-8 flex items-center justify-center bg-gray-700 rounded-full"><i class="fa-solid fa-times"></i></button>
            </div>
            <div class="p-2 bg-blue-900/40 text-blue-200 text-[10px] text-center">
                <i class="fa-solid fa-wifi"></i> Free Web Call &nbsp;|&nbsp; <i class="fa-solid fa-mobile-screen"></i> Normal Call
            </div>
            <div class="flex-1 overflow-y-auto p-4 space-y-3" id="branchList">
                <!-- List injected via JS -->
            </div>
        </div>

        <!-- 2. INCOMING CALL SCREEN -->
        <div id="incomingCallModal" class="hidden absolute inset-0 z-[60] bg-gray-900 flex flex-col items-center justify-center text-white animate-enter">
            <div class="relative z-10 flex flex-col items-center">
                <div class="w-24 h-24 bg-teal-500 rounded-full flex items-center justify-center mb-6 ringing-animation shadow-[0_0_40px_rgba(20,184,166,0.6)]">
                    <i class="fa-solid fa-phone text-4xl"></i>
                </div>
                <h2 class="text-2xl font-bold mb-2">Incoming Call</h2>
                <p id="callerName" class="text-teal-400 font-bold text-xl mb-12 tracking-wide">Head Office</p>
                
                <div class="flex gap-10">
                    <button onclick="rejectCall()" class="flex flex-col items-center gap-2 group">
                        <div class="w-16 h-16 bg-red-500 rounded-full flex items-center justify-center shadow-lg active:scale-95 transition">
                            <i class="fa-solid fa-phone-slash text-2xl"></i>
                        </div>
                        <span class="text-xs font-bold text-gray-400">Decline</span>
                    </button>
                    <button onclick="answerCall()" class="flex flex-col items-center gap-2 group">
                        <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center shadow-lg active:scale-95 transition">
                            <i class="fa-solid fa-phone text-2xl animate-pulse"></i>
                        </div>
                        <span class="text-xs font-bold text-gray-400">Accept</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- 3. ACTIVE CALL SCREEN -->
        <div id="activeCallModal" class="hidden absolute inset-0 z-[60] bg-gray-900 flex flex-col items-center justify-center text-white">
             <div class="absolute top-6 right-6 flex items-center gap-2 bg-red-500/20 px-3 py-1 rounded-full border border-red-500/30">
                <span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span> 
                <span class="text-[10px] font-bold tracking-widest">LIVE AUDIO</span>
            </div>
            
            <div class="w-32 h-32 bg-gray-800 rounded-full flex items-center justify-center mb-6 border-4 border-gray-700 shadow-2xl relative">
                <i class="fa-solid fa-user text-5xl text-gray-500"></i>
            </div>
            
            <h2 class="text-2xl font-bold mb-2" id="activeCallTarget">Connected</h2>
            <p class="text-teal-400 text-sm mb-12 font-mono" id="callStatus">Establishing Audio...</p>
            
            <button onclick="endCall()" class="w-20 h-20 bg-red-600 rounded-full flex items-center justify-center shadow-xl hover:bg-red-700 active:scale-95 transition">
                <i class="fa-solid fa-phone-slash text-3xl"></i>
            </button>
        </div>

        <!-- 4. EMOJI PICKER -->
        <div id="emojiPicker" class="hidden absolute bottom-[70px] left-2 right-2 bg-white shadow-2xl border border-gray-200 rounded-xl p-3 z-30 animate-enter">
            <div class="emoji-grid" id="emojiGrid"></div>
        </div>

        <!-- 5. RECORDING INDICATOR -->
        <div id="recordingOverlay" class="hidden absolute bottom-[80px] left-0 right-0 z-30 flex justify-center animate-enter pointer-events-none">
            <div class="bg-red-500 text-white px-5 py-2 rounded-full shadow-lg flex items-center gap-3 backdrop-blur-md">
                <div class="w-3 h-3 bg-white rounded-full animate-pulse"></div>
                <span class="text-xs font-bold uppercase tracking-wider">Recording...</span>
            </div>
        </div>

        <!-- 6. PROCESSING LOADER -->
        <div id="uploadLoader" class="hidden absolute inset-0 bg-white/80 z-40 flex items-center justify-center backdrop-blur-sm">
            <div class="flex flex-col items-center">
                <i class="fa-solid fa-circle-notch fa-spin text-teal-600 text-3xl mb-2"></i>
                <span class="text-xs text-gray-500 font-bold uppercase">Processing</span>
            </div>
        </div>

        <!-- INPUT AREA -->
        <div class="p-3 bg-white border-t border-gray-100 shrink-0 z-20">
            <div class="flex items-end gap-2 bg-gray-50 p-1.5 rounded-3xl border border-gray-200">
                <div class="flex pb-1 pl-1">
                    <input type="file" id="imageInput" accept="image/*" class="hidden" onchange="handleImageUpload(this)">
                    <button onclick="document.getElementById('imageInput').click()" class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-teal-600 transition">
                        <i class="fa-solid fa-paperclip"></i>
                    </button>
                    <button onclick="toggleEmoji()" class="w-8 h-8 flex items-center justify-center text-gray-400 hover:text-yellow-500 transition">
                        <i class="fa-regular fa-face-smile"></i>
                    </button>
                </div>
                <textarea id="chatMsg" rows="1" placeholder="Type Message..." class="flex-1 bg-transparent text-sm py-2 max-h-24 resize-none focus:outline-none text-gray-700" onkeypress="handleEnter(event)"></textarea>
                <div class="flex pb-1 pr-1 gap-1">
                    <button id="micBtn" onclick="toggleVoiceRecording()" class="w-8 h-8 rounded-full bg-gray-200 text-gray-500 hover:bg-red-100 hover:text-red-500 transition flex items-center justify-center">
                        <i class="fa-solid fa-microphone text-sm"></i>
                    </button>
                    <button onclick="sendRealtimeMessage()" class="w-8 h-8 rounded-full bg-teal-600 text-white shadow-md hover:bg-teal-700 transition flex items-center justify-center">
                        <i class="fa-solid fa-paper-plane text-xs"></i>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, serverTimestamp, query, limitToLast, remove, onChildAdded } 
        from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCPYqMnRIapygJqaKe6JZpitF3E5fq8jIs",
            authDomain: "biotechchat-c0a38.firebaseapp.com",
            projectId: "biotechchat-c0a38",
            storageBucket: "biotechchat-c0a38.firebasestorage.app",
            messagingSenderId: "1081724102554",
            appId: "1:1081724102554:web:16b0c1ee763148b4a63c23"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const chatRef = ref(db, 'biotech_messages');
        
        // --- WebRTC Variables ---
        let localStream;
        let peerConnection;
        const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
        let currentCallRef = null;
        let myBranchName = "";

        const branches = [
            { id: "HEAD OFFICE", name: "Head Office" },
            { id: "VEYANGODA", name: "Veyangoda" },
            { id: "Naiwala", name: "Naiwala" },
            { id: "BANDARANAYAKE", name: "Bandaranaye" },
            { id: "BANDURAGODA", name: "Banduragoda" }
        ];

        function renderBranchList() {
            const list = document.getElementById('branchList');
            const myId = document.getElementById('branchIdentity').value;
            list.innerHTML = branches.filter(b => b.id !== myId).map(b => `
                <div class="flex items-center justify-between p-3 bg-gray-700/50 rounded-xl border border-gray-600/50 hover:bg-gray-700 transition group">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-teal-500/20 text-teal-400 flex items-center justify-center font-bold text-xs border border-teal-500/30">${b.id.substring(0,2)}</div>
                        <span class="text-sm font-bold text-gray-200">${b.name}</span>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="window.initiateCall('${b.id}')" class="w-9 h-9 rounded-full bg-green-500/20 text-green-400 border border-green-500/30 hover:bg-green-500 hover:text-white transition flex items-center justify-center shadow-lg">
                            <i class="fa-solid fa-microphone"></i>
                        </button>
                        <a href="tel:+94767810623" class="w-9 h-9 rounded-full bg-blue-500/20 text-blue-400 border border-blue-500/30 hover:bg-blue-500 hover:text-white transition flex items-center justify-center shadow-lg">
                            <i class="fa-solid fa-phone"></i>
                        </a>
                    </div>
                </div>
            `).join('');
        }

        // --- WEBRTC CALL LOGIC (FIXED: ICE CANDIDATES) ---
        window.initiateCall = async function(targetBranch) {
            myBranchName = document.getElementById('branchIdentity').value;
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            } catch(e) { alert("Microphone access denied!"); return; }

            peerConnection = new RTCPeerConnection(rtcConfig);
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            
            const audioEl = document.getElementById('remoteAudio');
            peerConnection.ontrack = event => {
                audioEl.srcObject = event.streams[0];
                audioEl.play().catch(e => console.log("Autoplay blocked:", e));
            };
            
            // Send ICE Candidates
            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    push(ref(db, `biotech_calls/${targetBranch}/candidates`), {
                        candidate: JSON.stringify(event.candidate),
                        sender: myBranchName
                    });
                }
            };

            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);

            // Set Call Node
            const callBase = `biotech_calls/${targetBranch}`;
            currentCallRef = ref(db, callBase);
            
            // Clear previous candidates
            set(ref(db, `${callBase}/candidates`), null);

            // Send Offer
            set(ref(db, `${callBase}/offer`), {
                caller: myBranchName,
                sdp: JSON.stringify(peerConnection.localDescription),
                timestamp: serverTimestamp()
            });

            document.getElementById('callModal').classList.add('hidden');
            document.getElementById('activeCallModal').classList.remove('hidden');
            document.getElementById('activeCallTarget').innerText = "Calling " + targetBranch + "...";
            
            // Listen for Answer
            onValue(ref(db, `${callBase}/answer`), (snapshot) => {
                const data = snapshot.val();
                if (data && !peerConnection.currentRemoteDescription) {
                    const desc = new RTCSessionDescription(JSON.parse(data.sdp));
                    peerConnection.setRemoteDescription(desc);
                    document.getElementById('callStatus').innerText = "Voice Connected";
                }
            });

            // Listen for Remote Candidates
            onChildAdded(ref(db, `${callBase}/candidates`), (snapshot) => {
                const data = snapshot.val();
                if (data && data.sender !== myBranchName) {
                    peerConnection.addIceCandidate(new RTCIceCandidate(JSON.parse(data.candidate)));
                }
            });
        };

        window.answerCall = async function() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            } catch(e) { alert("Mic Error"); return; }

            peerConnection = new RTCPeerConnection(rtcConfig);
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            
            const audioEl = document.getElementById('remoteAudio');
            peerConnection.ontrack = event => {
                audioEl.srcObject = event.streams[0];
                audioEl.play().catch(e => console.log("Autoplay blocked:", e));
            };

            myBranchName = document.getElementById('branchIdentity').value;
            const callBase = `biotech_calls/${myBranchName}`;
            currentCallRef = ref(db, callBase);

            // Send ICE Candidates
            peerConnection.onicecandidate = event => {
                if (event.candidate) {
                    push(ref(db, `${callBase}/candidates`), {
                        candidate: JSON.stringify(event.candidate),
                        sender: myBranchName
                    });
                }
            };
            
            // Get Offer
            onValue(ref(db, `${callBase}/offer`), async (snapshot) => {
                const data = snapshot.val();
                if (data && !peerConnection.currentRemoteDescription) {
                    const remoteDesc = new RTCSessionDescription(JSON.parse(data.sdp));
                    await peerConnection.setRemoteDescription(remoteDesc);
                    
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    
                    // Send Answer
                    set(ref(db, `${callBase}/answer`), {
                        sdp: JSON.stringify(answer),
                        timestamp: serverTimestamp()
                    });

                    document.getElementById('incomingCallModal').classList.add('hidden');
                    document.getElementById('activeCallModal').classList.remove('hidden');
                    document.getElementById('activeCallTarget').innerText = data.caller;
                    document.getElementById('callStatus').innerText = "Voice Connected";
                }
            }, { onlyOnce: true });

            // Listen for Remote Candidates
            onChildAdded(ref(db, `${callBase}/candidates`), (snapshot) => {
                const data = snapshot.val();
                if (data && data.sender !== myBranchName) {
                    peerConnection.addIceCandidate(new RTCIceCandidate(JSON.parse(data.candidate)));
                }
            });

            // Watch for Hangup
            onValue(ref(db, `${callBase}/offer`), (snapshot) => {
                 if(!snapshot.exists()) window.endCall();
            });
        };

        window.rejectCall = function() {
            myBranchName = document.getElementById('branchIdentity').value;
            remove(ref(db, `biotech_calls/${myBranchName}`));
            document.getElementById('incomingCallModal').classList.add('hidden');
        };

        window.endCall = function() {
            if (peerConnection) peerConnection.close();
            if (localStream) localStream.getTracks().forEach(track => track.stop());
            if (currentCallRef) remove(currentCallRef);
            
            document.getElementById('activeCallModal').classList.add('hidden');
            document.getElementById('incomingCallModal').classList.add('hidden');
            
            // Force reload to clean up all WebRTC states
            setTimeout(() => location.reload(), 500);
        };

        function listenForCalls() {
            myBranchName = document.getElementById('branchIdentity').value;
            const myOfferRef = ref(db, `biotech_calls/${myBranchName}/offer`);
            
            onValue(myOfferRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    document.getElementById('callerName').innerText = data.caller;
                    document.getElementById('incomingCallModal').classList.remove('hidden');
                    // Play a ring sound if desired
                } else {
                    document.getElementById('incomingCallModal').classList.add('hidden');
                }
            });
        }

        // --- CHAT LOGIC ---
        let firstLoad = true;
        let lastMsgTimestamp = 0;

        if ("Notification" in window) {
            if (Notification.permission !== "granted") Notification.requestPermission();
        }

        window.sendRealtimeMessage = function() {
            const input = document.getElementById('chatMsg');
            const text = input.value.trim();
            const branch = document.getElementById('branchIdentity').value;

            if (text) {
                push(chatRef, {
                    sender: branch,
                    text: text,
                    type: 'text',
                    timestamp: serverTimestamp()
                });
                input.value = "";
                document.getElementById('emojiPicker').classList.add('hidden');
            }
        };

        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;

        window.toggleVoiceRecording = function() {
            if (!isRecording) startRecording();
            else stopRecording();
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                mediaRecorder.start();
                isRecording = true;
                document.getElementById('micBtn').classList.add('recording-pulse');
                document.getElementById('recordingOverlay').classList.remove('hidden');
                audioChunks = [];
                mediaRecorder.addEventListener("dataavailable", event => audioChunks.push(event.data));
                mediaRecorder.addEventListener("stop", () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const reader = new FileReader();
                    reader.readAsDataURL(audioBlob); 
                    reader.onloadend = function() {
                        const base64data = reader.result;
                        push(chatRef, {
                            sender: document.getElementById('branchIdentity').value,
                            audio: base64data,
                            type: 'audio',
                            timestamp: serverTimestamp()
                        });
                        document.getElementById('uploadLoader').classList.add('hidden');
                    }
                });
            } catch (err) { alert("Mic access denied"); }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                document.getElementById('uploadLoader').classList.remove('hidden');
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                isRecording = false;
                document.getElementById('micBtn').classList.remove('recording-pulse');
                document.getElementById('recordingOverlay').classList.add('hidden');
            }
        }

        window.clearChat = function() {
            const pw = prompt("Password:");
            if (pw === "12987654321") {
                if(confirm("Delete all messages?")) set(chatRef, null);
            } else if (pw !== null) alert("Wrong Password");
        }

        window.handleImageUpload = function(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                document.getElementById('uploadLoader').classList.remove('hidden');
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        let width = img.width; let height = img.height;
                        const MAX = 800;
                        if (width > MAX) { height *= MAX / width; width = MAX; }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        push(chatRef, {
                            sender: document.getElementById('branchIdentity').value,
                            image: canvas.toDataURL('image/jpeg', 0.6),
                            type: 'image',
                            timestamp: serverTimestamp()
                        });
                        document.getElementById('uploadLoader').classList.add('hidden');
                        input.value = ''; 
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        window.handleEnter = function(e) {
            if(e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                window.sendRealtimeMessage();
            }
        }

        const recentMessagesQuery = query(chatRef, limitToLast(50));
        onValue(recentMessagesQuery, (snapshot) => {
            const container = document.getElementById('chatContainer');
            if(firstLoad) { container.innerHTML = ""; firstLoad = false; }
            const data = snapshot.val();
            container.innerHTML = "";
            if (!data) {
                container.innerHTML = `<div class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 opacity-40"><i class="fa-regular fa-comment-dots text-4xl mb-2"></i><span class="text-xs">No Messages</span></div>`;
                return;
            }
            const messages = Object.values(data);
            messages.forEach(msg => renderMessage(msg));
            container.scrollTop = container.scrollHeight;
        });

        function renderMessage(msg) {
            const container = document.getElementById('chatContainer');
            const myBranch = document.getElementById('branchIdentity').value;
            const isMe = msg.sender === myBranch;
            const alignClass = isMe ? 'msg-sent' : 'msg-received';
            const alignContainer = isMe ? 'items-end' : 'items-start';
            let content = "";
            if (msg.type === 'image') content = `<img src="${msg.image}" class="rounded-lg max-w-full h-auto border-2 border-white/20 mt-1">`;
            else if (msg.type === 'audio') content = `<audio controls src="${msg.audio}" class="mt-1"></audio>`;
            else content = `<p class="whitespace-pre-wrap">${msg.text || ''}</p>`;

            const div = document.createElement('div');
            div.className = `flex flex-col ${alignContainer} animate-enter w-full`;
            div.innerHTML = `
                <div class="max-w-[85%] rounded-xl px-3 py-2 ${alignClass} text-sm relative group mb-1">
                    <div class="text-[9px] font-bold opacity-75 uppercase mb-0.5">${msg.sender}</div>
                    ${content}
                    <div class="text-[9px] opacity-60 text-right mt-1">${new Date(msg.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                </div>`;
            container.appendChild(div);
        }

        window.updateIdentity = function() {
            const selected = document.getElementById('branchIdentity').value;
            localStorage.setItem("biotechBranch", selected);
            location.reload(); 
        }

        const savedBranch = localStorage.getItem("biotechBranch");
        if(savedBranch) document.getElementById('branchIdentity').value = savedBranch;
        
        renderBranchList();
        listenForCalls();
    </script>

    <!-- UI JS -->
    <script>
        window.toggleCallModal = function() { document.getElementById('callModal').classList.toggle('hidden'); }
        
        const emojis = ["üëç", "üëã", "üß™", "‚úÖ", "‚ùå", "üòä", "üòÇ", "ü©∏", "ü¶†", "üî¨", "üè•", "üöë", "üíä", "üßæ", "üíµ", "‚ùó", "‚ùì", "üìû"];
        document.addEventListener("DOMContentLoaded", function() {
            document.getElementById('emojiGrid').innerHTML = emojis.map(e => `<div class="emoji-btn" onclick="insertEmoji('${e}')">${e}</div>`).join('');
        });

        window.toggleEmoji = function() { document.getElementById('emojiPicker').classList.toggle('hidden'); }
        window.insertEmoji = function(e) { document.getElementById('chatMsg').value += e; document.getElementById('chatMsg').focus(); }
    </script>
</body>
</html>
